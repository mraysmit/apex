# Custody and Safekeeping Auto-Repair Rules Configuration
# Standing Instruction (SI) Auto-Repair for Asian Markets
# Demonstrates weighted rule-based decision making for settlement instruction repair

metadata:
  name: "Custody Auto-Repair Rules"
  version: "1.0"
  description: "Standing Instruction auto-repair rules for custody settlement in Asian markets"
  author: "Mark Andrew Ray-Smith Cityline Ltd"
  created: "2025-07-29"
  tags: ["custody", "settlement", "auto-repair", "asian-markets", "standing-instructions"]

# Rule chains using accumulative chaining pattern for weighted decision making
rule-chains:
  - id: "si-auto-repair-chain"
    name: "Standing Instruction Auto-Repair Chain"
    description: "Weighted evaluation of client, market, and instrument level standing instructions"
    pattern: "accumulative-chaining"
    enabled: true
    priority: 100
    configuration:
      accumulator-variable: "repairScore"
      initial-value: 0
      accumulation-rules:
        # Client-level rules (highest weight: 0.6)
        - id: "client-level-si-rule"
          condition: "#instruction.clientId != null && #availableClientSIs.containsKey(#instruction.clientId) ? 60 : 0"
          message: "Client-level SI evaluation"
          weight: 0.6
        # Market-level rules (medium weight: 0.3)  
        - id: "market-level-si-rule"
          condition: "#instruction.market != null && #availableMarketSIs.containsKey(#instruction.market) ? 30 : 0"
          message: "Market-level SI evaluation"
          weight: 0.3
        # Instrument-level rules (lowest weight: 0.1)
        - id: "instrument-level-si-rule"
          condition: "#instruction.instrumentType != null && #availableInstrumentSIs.containsKey(#instruction.instrumentType) ? 10 : 0"
          message: "Instrument-level SI evaluation"
          weight: 0.1
      final-decision-rule:
        id: "repair-decision"
        condition: "#repairScore >= 50 ? 'REPAIR_APPROVED' : (#repairScore >= 20 ? 'PARTIAL_REPAIR' : 'MANUAL_REVIEW_REQUIRED')"
        message: "Final auto-repair decision based on weighted scoring"

  - id: "eligibility-check-chain"
    name: "Auto-Repair Eligibility Check"
    description: "Pre-flight checks for auto-repair eligibility"
    pattern: "conditional-chaining"
    enabled: true
    priority: 200
    configuration:
      trigger-rule:
        id: "basic-eligibility"
        condition: "#instruction.requiresRepair && !#instruction.highValueTransaction && !#instruction.clientOptOut"
        message: "Basic eligibility criteria met"
      conditional-rules:
        on-trigger:
          - id: "confidence-threshold-check"
            condition: "#confidenceThreshold == null || #confidenceThreshold <= 0.7"
            message: "Confidence threshold check passed"
        on-no-trigger:
          - id: "eligibility-failure"
            condition: "false"
            message: "Instruction not eligible for auto-repair"

# Enrichments for standing instruction lookup and field population
enrichments:
  # Client Standing Instructions Enrichment
  - id: "client-si-enrichment"
    name: "Client Standing Instructions Lookup"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 100
    condition: "#instruction.clientId != null"
    lookup-config:
      lookup-dataset:
        type: "inline"
        key-field: "clientId"
        data:
          - clientId: "CLIENT_A"
            siId: "SI_CLIENT_A"
            siName: "Client A Default SI"
            scopeType: "CLIENT"
            weight: 0.6
            confidenceLevel: 0.95
            defaultCounterpartyId: "CP_CLIENT_A_DEFAULT"
            defaultCounterpartyName: "Client A Default Counterparty"
            defaultCounterpartyBic: "CLIENTABIC"
            defaultCustodianId: "CUST_CLIENT_A"
            defaultCustodianName: "Client A Custodian"
            defaultSettlementMethod: "DVP"
            defaultDeliveryInstruction: "DELIVER"
            enabled: true
            riskCategory: "LOW"
          - clientId: "CLIENT_B"
            siId: "SI_CLIENT_B"
            siName: "Client B Specific SI"
            scopeType: "CLIENT"
            weight: 0.6
            confidenceLevel: 0.90
            defaultCounterpartyId: "CP_CLIENT_B_PREMIUM"
            defaultCounterpartyName: "Client B Premium Counterparty"
            defaultCounterpartyBic: "CLIENTBBIC"
            defaultCustodianId: "CUST_CLIENT_B_PREMIUM"
            defaultSettlementMethod: "DVP_PREMIUM"
            enabled: true
            riskCategory: "MEDIUM"
          - clientId: "PREMIUM_CLIENT_X"
            siId: "SI_PREMIUM_X"
            siName: "Premium Client X SI"
            scopeType: "CLIENT"
            weight: 0.6
            confidenceLevel: 0.98
            defaultCounterpartyId: "CP_PREMIUM_GLOBAL"
            defaultCounterpartyName: "Premium Global Counterparty"
            defaultCustodianId: "CUST_PREMIUM_GLOBAL"
            defaultCustodianName: "Premium Global Custodian"
            defaultSettlementMethod: "DVP_PREMIUM"
            defaultDeliveryInstruction: "DELIVER"
            enabled: true
            riskCategory: "LOW"
            businessJustification: "Premium client with global custody arrangement"
    field-mappings:
      - source-field: "siId"
        target-field: "applicableClientSI.siId"
      - source-field: "siName"
        target-field: "applicableClientSI.siName"
      - source-field: "weight"
        target-field: "applicableClientSI.weight"
      - source-field: "confidenceLevel"
        target-field: "applicableClientSI.confidenceLevel"
      - source-field: "defaultCounterpartyId"
        target-field: "applicableClientSI.defaultCounterpartyId"
      - source-field: "defaultCustodianId"
        target-field: "applicableClientSI.defaultCustodianId"
      - source-field: "defaultSettlementMethod"
        target-field: "applicableClientSI.defaultSettlementMethod"

  # Market Standing Instructions Enrichment
  - id: "market-si-enrichment"
    name: "Market Standing Instructions Lookup"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 200
    condition: "#instruction.market != null"
    lookup-config:
      lookup-dataset:
        type: "inline"
        key-field: "market"
        data:
          - market: "JAPAN"
            siId: "SI_JAPAN"
            siName: "Japan Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.85
            defaultCustodianId: "CUST_JAPAN_DEFAULT"
            defaultCustodianName: "Japan Default Custodian"
            defaultCustodianBic: "JAPANCUST"
            defaultCounterpartyId: "CP_JAPAN_STANDARD"
            defaultCounterpartyName: "Japan Standard Counterparty"
            defaultSettlementMethod: "DVP"
            defaultDeliveryInstruction: "DELIVER"
            marketMic: "XJPX"
            localMarketCode: "TSE"
            settlementCycle: "T+2"
            enabled: true
          - market: "HONG_KONG"
            siId: "SI_HONG_KONG"
            siName: "Hong Kong Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.88
            defaultCustodianId: "CUST_HK_STANDARD"
            defaultCustodianName: "Hong Kong Standard Custodian"
            defaultCustodianBic: "HKSTDCUST"
            defaultCounterpartyId: "CP_HK_STANDARD"
            defaultCounterpartyName: "Hong Kong Standard Counterparty"
            defaultSettlementMethod: "DVP"
            marketMic: "XHKG"
            localMarketCode: "HKEX"
            settlementCycle: "T+2"
            enabled: true
          - market: "SINGAPORE"
            siId: "SI_SINGAPORE"
            siName: "Singapore Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.87
            defaultCustodianId: "CUST_SG_STANDARD"
            defaultCustodianName: "Singapore Standard Custodian"
            defaultCounterpartyId: "CP_SG_STANDARD"
            defaultCounterpartyName: "Singapore Standard Counterparty"
            defaultSettlementMethod: "DVP"
            marketMic: "XSES"
            localMarketCode: "SGX"
            settlementCycle: "T+2"
            enabled: true
          - market: "KOREA"
            siId: "SI_KOREA"
            siName: "Korea Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.83
            defaultCustodianId: "CUST_KR_STANDARD"
            defaultCustodianName: "Korea Standard Custodian"
            defaultCounterpartyId: "CP_KR_STANDARD"
            defaultCounterpartyName: "Korea Standard Counterparty"
            defaultSettlementMethod: "DVP"
            marketMic: "XKRX"
            localMarketCode: "KRX"
            settlementCycle: "T+2"
            enabled: true
    field-mappings:
      - source-field: "siId"
        target-field: "applicableMarketSI.siId"
      - source-field: "siName"
        target-field: "applicableMarketSI.siName"
      - source-field: "weight"
        target-field: "applicableMarketSI.weight"
      - source-field: "confidenceLevel"
        target-field: "applicableMarketSI.confidenceLevel"
      - source-field: "defaultCustodianId"
        target-field: "applicableMarketSI.defaultCustodianId"
      - source-field: "defaultCounterpartyId"
        target-field: "applicableMarketSI.defaultCounterpartyId"
      - source-field: "defaultSettlementMethod"
        target-field: "applicableMarketSI.defaultSettlementMethod"
      - source-field: "marketMic"
        target-field: "enrichedMarketMic"
      - source-field: "settlementCycle"
        target-field: "enrichedSettlementCycle"
