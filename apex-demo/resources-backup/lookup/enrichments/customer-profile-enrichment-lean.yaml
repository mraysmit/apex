# Customer Profile Enrichment Rules - Lean Version with External Data-Source References
# Demonstrates separation of infrastructure configuration from business logic
# Use Case: Enrich transactions with customer profile data using external data-source references

metadata:
  name: "Customer Profile Enrichment - Lean Version"
  description: "Demonstrates external data-source references for clean separation of concerns"
  version: "2.1.0"
  type: "rule-config"
  author: "APEX Demo Team"

# Reference to external data-source configurations
data-source-refs:
  - name: "customer-database"
    source: "data-sources/customer-database.yaml"
    enabled: true
    description: "Customer database for profile lookups"

# Lean enrichment rules focused on business logic only
enrichments:
  - id: "customer-profile-lookup-lean"
    type: "lookup-enrichment"
    description: "Enrich transactions with customer profile data using external data-source reference"
    condition: "#customerId != null && #customerId != ''"

    lookup-config:
      lookup-key: "#customerId"
      lookup-dataset:
        type: "database"
        data-source-ref: "customer-database"
        query-ref: "getActiveCustomerById"  # Reference to named query in external config
        parameters:
          - field: "customerId"
            type: "string"

    # Field mappings from database columns to enriched object fields
    field-mappings:
      - source-field: "CUSTOMER_NAME"
        target-field: "customerName"
        required: true
      - source-field: "CUSTOMER_TYPE"
        target-field: "customerType"
        required: true
      - source-field: "TIER"
        target-field: "customerTier"
        required: true
      - source-field: "REGION"
        target-field: "customerRegion"
        required: true
      - source-field: "STATUS"
        target-field: "customerStatus"
        required: true
      - source-field: "CREATED_DATE"
        target-field: "customerCreatedDate"
        required: false

  # Additional enrichment using different named query
  - id: "customer-region-lookup"
    type: "lookup-enrichment"
    description: "Enrich with regional customer information"
    condition: "#region != null && #region != ''"

    lookup-config:
      lookup-key: "#region"
      lookup-dataset:
        type: "database"
        data-source-ref: "customer-database"
        query-ref: "getCustomersByRegion"  # Different named query
        parameters:
          - field: "region"
            type: "string"

    field-mappings:
      - source-field: "customer_id"
        target-field: "regionalCustomers"
        required: false
