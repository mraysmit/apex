# Settlement Instruction Multi-Parameter Enrichment Rules - Database Version
# Demonstrates complex multi-parameter database lookup enrichment using APEX YAML processing
# Use Case: Enrich trades with settlement instructions and risk assessment data from database

type: "apex-enrichment-config"
name: "Settlement Instruction Multi-Parameter Enrichment Demo - Database Version"
  description: "Demonstrates complex multi-parameter database lookup enrichment using APEX YAML processing"
  version: "2.0.0"
  type: "rule-config"
  author: "APEX Demo Team"

# Database configuration for settlement and risk data
data-sources:
  - name: "settlement-database"
    type: "database"
    source-type: "h2"
    connection:
      database: "apex_demo_shared"
      username: "sa"
      password: ""

# Multi-step enrichment rules using verified APEX syntax with database lookups
enrichments:
  # Step 1: Settlement Instruction Database Lookup
  - id: "settlement-instruction-database-lookup"
    type: "lookup-enrichment"
    description: "Enrich trades with settlement instructions using database lookup"
    condition: "#counterpartyId != null && #counterpartyId != ''"
    
    lookup-config:
      lookup-key: "#counterpartyId"
      lookup-dataset:
        type: "database"
        connection-name: "settlement-database"
        query: |
          SELECT 
            si.instruction_id,
            cp.counterparty_name,
            cp.counterparty_type,
            cp.credit_rating,
            si.custodian_name,
            si.custodian_bic,
            si.settlement_method,
            si.delivery_instruction,
            si.market_name,
            si.settlement_cycle,
            ra.risk_category,
            ra.risk_score,
            ra.max_exposure,
            ra.approval_required,
            ra.monitoring_level
          FROM counterparties cp
          LEFT JOIN settlement_instructions si ON cp.counterparty_id = si.counterparty_id
          LEFT JOIN risk_assessments ra ON cp.counterparty_id = ra.counterparty_id
          WHERE cp.counterparty_id = :counterpartyId
          AND cp.status = 'ACTIVE'
        parameters:
          - field: "counterpartyId"
            type: "string"
      
      # Field mappings from database columns to enriched object fields
      field-mappings:
        - source-field: "instruction_id"
          target-field: "settlementInstructionId"
        - source-field: "counterparty_name"
          target-field: "counterpartyName"
        - source-field: "counterparty_type"
          target-field: "counterpartyType"
        - source-field: "credit_rating"
          target-field: "counterpartyCreditRating"
        - source-field: "custodian_name"
          target-field: "custodianName"
        - source-field: "custodian_bic"
          target-field: "custodianBic"
        - source-field: "settlement_method"
          target-field: "settlementMethod"
        - source-field: "delivery_instruction"
          target-field: "deliveryInstruction"
        - source-field: "market_name"
          target-field: "marketName"
        - source-field: "settlement_cycle"
          target-field: "settlementCycle"
        - source-field: "risk_category"
          target-field: "riskCategory"
        - source-field: "risk_score"
          target-field: "riskScore"
        - source-field: "max_exposure"
          target-field: "maxExposure"
        - source-field: "approval_required"
          target-field: "approvalRequired"
        - source-field: "monitoring_level"
          target-field: "monitoringLevel"

