metadata:
  name: "PostgreSQL Customer Profile Enrichment - External Reference"
  version: "2.1.0"
  description: "Customer profile enrichment using external PostgreSQL data-source reference"
  author: "APEX Demo Team"
  created: "2025-08-28"
  tags:
    - "customer"
    - "database"
    - "postgresql"
    - "external-reference"

# External data-source references (infrastructure configuration)
data-source-refs:
  - name: "postgresql-customer-database"
    source: "data-sources/postgresql-customer-database.yaml"
    enabled: true
    description: "PostgreSQL customer database for profile enrichment"

# Business logic enrichments (lean and focused)
enrichments:
  # Primary customer profile enrichment
  - id: "postgresql-customer-profile-lookup"
    type: "lookup-enrichment"
    description: "Enrich customer data using PostgreSQL database lookup"
    condition: "#customerId != null && #customerId != ''"

    lookup-config:
      lookup-key: "#customerId"
      lookup-dataset:
        type: "database"
        data-source-ref: "postgresql-customer-database"
        query-ref: "getActiveCustomerById"  # Named query from external config
        parameters:
          - field: "customerId"
            type: "string"

    # Field mappings from database columns to enriched object fields
    field-mappings:
      - source-field: "CUSTOMER_NAME"
        target-field: "customerName"
        required: true
      - source-field: "CUSTOMER_TYPE"
        target-field: "customerType"
        required: true
      - source-field: "TIER"
        target-field: "customerTier"
        required: true
      - source-field: "REGION"
        target-field: "customerRegion"
        required: true
      - source-field: "STATUS"
        target-field: "customerStatus"
        required: true
      - source-field: "CREATED_DATE"
        target-field: "customerCreatedDate"
        required: false

  # Additional enrichment for customer validation
  - id: "postgresql-customer-validation"
    type: "lookup-enrichment"
    description: "Validate customer exists and is active"
    condition: "#customerId != null && #customerId != ''"

    lookup-config:
      lookup-key: "#customerId"
      lookup-dataset:
        type: "database"
        data-source-ref: "postgresql-customer-database"
        query-ref: "getActiveCustomerById"
        parameters:
          - field: "customerId"
            type: "string"

    field-mappings:
      - source-field: "CUSTOMER_ID"
        target-field: "validCustomer"
        required: false
        transform: "#CUSTOMER_ID != null ? true : false"
