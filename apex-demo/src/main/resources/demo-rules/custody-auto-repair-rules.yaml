# ============================================================================
# APEX Rules Engine - Custody Auto-Repair Configuration
# ============================================================================
#
# This YAML configuration implements sophisticated auto-repair logic for
# custody and safekeeping settlement instructions in Asian financial markets.
# It demonstrates advanced rule chaining patterns and weighted decision making.
#
# OVERVIEW:
# This configuration automates the repair of failed settlement instructions
# by intelligently selecting appropriate Standing Instructions (SIs) based
# on client preferences, market conventions, and instrument characteristics.
#
# BUSINESS CONTEXT:
# In custody operations, settlement instructions sometimes fail due to:
# - Missing or incorrect settlement details
# - Changes in counterparty information
# - Market-specific settlement conventions
# - Client preference updates
# - Regulatory requirement changes
#
# AUTO-REPAIR PROCESS:
# 1. ELIGIBILITY CHECK - Determines if instruction can be auto-repaired
#    - Client authorization verification
#    - Market operating hours validation
#    - Instruction type compatibility
#    - Risk threshold compliance
#
# 2. WEIGHTED EVALUATION - Scores available Standing Instructions
#    - Client-level SIs (60% weight) - Highest priority
#    - Market-level SIs (30% weight) - Market conventions
#    - Instrument-level SIs (10% weight) - Asset-specific rules
#
# 3. DECISION MAKING - Determines repair action based on score
#    - Score ≥ 50: REPAIR_APPROVED (automatic repair)
#    - Score 20-49: PARTIAL_REPAIR (limited automation)
#    - Score < 20: MANUAL_REVIEW_REQUIRED (human intervention)
#
# ASIAN MARKET SPECIALIZATION:
# - Hong Kong (HK) settlement conventions
# - Singapore (SG) market practices
# - Japanese (JP) regulatory requirements
# - Korean (KR) market specifics
# - Multi-currency settlement support
#
# ADVANCED FEATURES:
# - Rule chaining with accumulative and conditional patterns
# - Weighted scoring algorithms for decision optimization
# - Market-specific business hours and cut-off times
# - Multi-level Standing Instruction hierarchy
# - Comprehensive audit trail and decision logging
#
# INTEGRATION POINTS:
# - Custody management systems
# - Settlement platforms (SWIFT, local networks)
# - Client reporting and notification systems
# - Risk management and compliance systems
# - Market data and reference data services
#
# ============================================================================

metadata:
  name: "Custody Auto-Repair Rules"
  version: "1.0"
  description: "Standing Instruction auto-repair rules for custody settlement in Asian markets"
  type: "rule-config"
  author: "Mark Andrew Ray-Smith Cityline Ltd"
  created: "2025-07-29"
  tags: ["custody", "settlement", "auto-repair", "asian-markets", "standing-instructions"]

# ============================================================================
# RULE CHAINS FOR AUTO-REPAIR DECISION MAKING
# ============================================================================
#
# These rule chains implement sophisticated decision-making logic using
# advanced chaining patterns to automate custody settlement instruction repair.
#
# CHAINING PATTERNS:
# 1. ACCUMULATIVE CHAINING - Builds weighted scores across multiple criteria
#    - Accumulates scores from client, market, and instrument level rules
#    - Uses configurable weights to prioritize different factors
#    - Produces final decision based on accumulated score thresholds
#
# 2. CONDITIONAL CHAINING - Sequential evaluation with early termination
#    - Evaluates pre-conditions before attempting repair
#    - Stops processing when conditions are not met
#    - Ensures only eligible instructions proceed to repair
#
# WEIGHTED SCORING ALGORITHM:
# - Client-level SIs: 60% weight (highest priority for client preferences)
# - Market-level SIs: 30% weight (market conventions and practices)
# - Instrument-level SIs: 10% weight (asset-specific requirements)
#
# DECISION THRESHOLDS:
# - Score ≥ 50: High confidence - automatic repair approved
# - Score 20-49: Medium confidence - partial repair with monitoring
# - Score < 20: Low confidence - manual review required
#
# BUSINESS LOGIC:
# - Prioritizes client-specific standing instructions
# - Falls back to market conventions when client SIs unavailable
# - Uses instrument defaults as last resort
# - Maintains audit trail of decision factors
#
rule-chains:
  - id: "si-auto-repair-chain"
    name: "Standing Instruction Auto-Repair Chain"
    description: "Weighted evaluation of client, market, and instrument level standing instructions"
    pattern: "accumulative-chaining"
    enabled: true
    priority: 100
    configuration:
      accumulator-variable: "repairScore"
      initial-value: 0
      accumulation-rules:
        # Client-level rules (highest weight: 0.6)
        - id: "client-level-si-rule"
          condition: "#instruction.clientId != null && #availableClientSIs.containsKey(#instruction.clientId) ? 60 : 0"
          message: "Client-level SI evaluation"
          weight: 0.6
        # Market-level rules (medium weight: 0.3)  
        - id: "market-level-si-rule"
          condition: "#instruction.market != null && #availableMarketSIs.containsKey(#instruction.market) ? 30 : 0"
          message: "Market-level SI evaluation"
          weight: 0.3
        # Instrument-level rules (lowest weight: 0.1)
        - id: "instrument-level-si-rule"
          condition: "#instruction.instrumentType != null && #availableInstrumentSIs.containsKey(#instruction.instrumentType) ? 10 : 0"
          message: "Instrument-level SI evaluation"
          weight: 0.1
      final-decision-rule:
        id: "repair-decision"
        condition: "#repairScore >= 50 ? 'REPAIR_APPROVED' : (#repairScore >= 20 ? 'PARTIAL_REPAIR' : 'MANUAL_REVIEW_REQUIRED')"
        message: "Final auto-repair decision based on weighted scoring"

  - id: "eligibility-check-chain"
    name: "Auto-Repair Eligibility Check"
    description: "Pre-flight checks for auto-repair eligibility"
    pattern: "conditional-chaining"
    enabled: true
    priority: 200
    configuration:
      trigger-rule:
        id: "basic-eligibility"
        condition: "#instruction.requiresRepair && !#instruction.highValueTransaction && !#instruction.clientOptOut"
        message: "Basic eligibility criteria met"
      conditional-rules:
        on-trigger:
          - id: "confidence-threshold-check"
            condition: "#confidenceThreshold == null || #confidenceThreshold <= 0.7"
            message: "Confidence threshold check passed"
        on-no-trigger:
          - id: "eligibility-failure"
            condition: "false"
            message: "Instruction not eligible for auto-repair"

# Enrichments for standing instruction lookup and field population
enrichments:
  # Client Standing Instructions Enrichment
  - id: "client-si-enrichment"
    name: "Client Standing Instructions Lookup"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 100
    condition: "#instruction.clientId != null"
    lookup-config:
      lookup-key: "#instruction.clientId"
      lookup-dataset:
        type: "inline"
        key-field: "clientId"
        data:
          - clientId: "CLIENT_A"
            siId: "SI_CLIENT_A"
            siName: "Client A Default SI"
            scopeType: "CLIENT"
            weight: 0.6
            confidenceLevel: 0.95
            defaultCounterpartyId: "CP_CLIENT_A_DEFAULT"
            defaultCounterpartyName: "Client A Default Counterparty"
            defaultCounterpartyBic: "CLIENTABIC"
            defaultCustodianId: "CUST_CLIENT_A"
            defaultCustodianName: "Client A Custodian"
            defaultSettlementMethod: "DVP"
            defaultDeliveryInstruction: "DELIVER"
            enabled: true
            riskCategory: "LOW"
          - clientId: "CLIENT_B"
            siId: "SI_CLIENT_B"
            siName: "Client B Specific SI"
            scopeType: "CLIENT"
            weight: 0.6
            confidenceLevel: 0.90
            defaultCounterpartyId: "CP_CLIENT_B_PREMIUM"
            defaultCounterpartyName: "Client B Premium Counterparty"
            defaultCounterpartyBic: "CLIENTBBIC"
            defaultCustodianId: "CUST_CLIENT_B_PREMIUM"
            defaultSettlementMethod: "DVP_PREMIUM"
            enabled: true
            riskCategory: "MEDIUM"
          - clientId: "PREMIUM_CLIENT_X"
            siId: "SI_PREMIUM_X"
            siName: "Premium Client X SI"
            scopeType: "CLIENT"
            weight: 0.6
            confidenceLevel: 0.98
            defaultCounterpartyId: "CP_PREMIUM_GLOBAL"
            defaultCounterpartyName: "Premium Global Counterparty"
            defaultCustodianId: "CUST_PREMIUM_GLOBAL"
            defaultCustodianName: "Premium Global Custodian"
            defaultSettlementMethod: "DVP_PREMIUM"
            defaultDeliveryInstruction: "DELIVER"
            enabled: true
            riskCategory: "LOW"
            businessJustification: "Premium client with global custody arrangement"
    field-mappings:
      - source-field: "siId"
        target-field: "applicableClientSI.siId"
      - source-field: "siName"
        target-field: "applicableClientSI.siName"
      - source-field: "weight"
        target-field: "applicableClientSI.weight"
      - source-field: "confidenceLevel"
        target-field: "applicableClientSI.confidenceLevel"
      - source-field: "defaultCounterpartyId"
        target-field: "applicableClientSI.defaultCounterpartyId"
      - source-field: "defaultCustodianId"
        target-field: "applicableClientSI.defaultCustodianId"
      - source-field: "defaultSettlementMethod"
        target-field: "applicableClientSI.defaultSettlementMethod"

  # Market Standing Instructions Enrichment
  - id: "market-si-enrichment"
    name: "Market Standing Instructions Lookup"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 200
    condition: "#instruction.market != null"
    lookup-config:
      lookup-key: "#instruction.market"
      lookup-dataset:
        type: "inline"
        key-field: "market"
        data:
          - market: "JAPAN"
            siId: "SI_JAPAN"
            siName: "Japan Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.85
            defaultCustodianId: "CUST_JAPAN_DEFAULT"
            defaultCustodianName: "Japan Default Custodian"
            defaultCustodianBic: "JAPANCUST"
            defaultCounterpartyId: "CP_JAPAN_STANDARD"
            defaultCounterpartyName: "Japan Standard Counterparty"
            defaultSettlementMethod: "DVP"
            defaultDeliveryInstruction: "DELIVER"
            marketMic: "XJPX"
            localMarketCode: "TSE"
            settlementCycle: "T+2"
            enabled: true
          - market: "HONG_KONG"
            siId: "SI_HONG_KONG"
            siName: "Hong Kong Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.88
            defaultCustodianId: "CUST_HK_STANDARD"
            defaultCustodianName: "Hong Kong Standard Custodian"
            defaultCustodianBic: "HKSTDCUST"
            defaultCounterpartyId: "CP_HK_STANDARD"
            defaultCounterpartyName: "Hong Kong Standard Counterparty"
            defaultSettlementMethod: "DVP"
            marketMic: "XHKG"
            localMarketCode: "HKEX"
            settlementCycle: "T+2"
            enabled: true
          - market: "SINGAPORE"
            siId: "SI_SINGAPORE"
            siName: "Singapore Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.87
            defaultCustodianId: "CUST_SG_STANDARD"
            defaultCustodianName: "Singapore Standard Custodian"
            defaultCounterpartyId: "CP_SG_STANDARD"
            defaultCounterpartyName: "Singapore Standard Counterparty"
            defaultSettlementMethod: "DVP"
            marketMic: "XSES"
            localMarketCode: "SGX"
            settlementCycle: "T+2"
            enabled: true
          - market: "KOREA"
            siId: "SI_KOREA"
            siName: "Korea Market SI"
            scopeType: "MARKET"
            weight: 0.3
            confidenceLevel: 0.83
            defaultCustodianId: "CUST_KR_STANDARD"
            defaultCustodianName: "Korea Standard Custodian"
            defaultCounterpartyId: "CP_KR_STANDARD"
            defaultCounterpartyName: "Korea Standard Counterparty"
            defaultSettlementMethod: "DVP"
            marketMic: "XKRX"
            localMarketCode: "KRX"
            settlementCycle: "T+2"
            enabled: true
    field-mappings:
      - source-field: "siId"
        target-field: "applicableMarketSI.siId"
      - source-field: "siName"
        target-field: "applicableMarketSI.siName"
      - source-field: "weight"
        target-field: "applicableMarketSI.weight"
      - source-field: "confidenceLevel"
        target-field: "applicableMarketSI.confidenceLevel"
      - source-field: "defaultCustodianId"
        target-field: "applicableMarketSI.defaultCustodianId"
      - source-field: "defaultCounterpartyId"
        target-field: "applicableMarketSI.defaultCounterpartyId"
      - source-field: "defaultSettlementMethod"
        target-field: "applicableMarketSI.defaultSettlementMethod"
      - source-field: "marketMic"
        target-field: "enrichedMarketMic"
      - source-field: "settlementCycle"
        target-field: "enrichedSettlementCycle"

  # Instrument Standing Instructions Enrichment
  - id: "instrument-si-enrichment"
    name: "Instrument Standing Instructions Lookup"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 300
    condition: "#instruction.instrumentType != null"
    lookup-config:
      lookup-key: "#instruction.instrumentType"
      lookup-dataset:
        type: "inline"
        key-field: "instrumentType"
        data:
          - instrumentType: "EQUITY"
            siId: "SI_EQUITY"
            siName: "Equity Instrument SI"
            scopeType: "INSTRUMENT"
            weight: 0.1
            confidenceLevel: 0.75
            defaultSettlementMethod: "DVP"
            defaultDeliveryInstruction: "DELIVER"
            typicalSettlementCycle: "T+2"
            riskCategory: "MEDIUM"
            enabled: true
          - instrumentType: "FIXED_INCOME"
            siId: "SI_FIXED_INCOME"
            siName: "Fixed Income SI"
            scopeType: "INSTRUMENT"
            weight: 0.1
            confidenceLevel: 0.80
            defaultSettlementMethod: "DVP"
            defaultDeliveryInstruction: "DELIVER"
            typicalSettlementCycle: "T+1"
            riskCategory: "LOW"
            enabled: true
          - instrumentType: "DERIVATIVES"
            siId: "SI_DERIVATIVES"
            siName: "Derivatives SI"
            scopeType: "INSTRUMENT"
            weight: 0.1
            confidenceLevel: 0.70
            defaultSettlementMethod: "CASH"
            defaultDeliveryInstruction: "CASH_SETTLE"
            typicalSettlementCycle: "T+0"
            riskCategory: "HIGH"
            enabled: true
          - instrumentType: "FX"
            siId: "SI_FX"
            siName: "Foreign Exchange SI"
            scopeType: "INSTRUMENT"
            weight: 0.1
            confidenceLevel: 0.85
            defaultSettlementMethod: "PVP"
            defaultDeliveryInstruction: "DELIVER"
            typicalSettlementCycle: "T+2"
            riskCategory: "MEDIUM"
            enabled: true
    field-mappings:
      - source-field: "siId"
        target-field: "applicableInstrumentSI.siId"
      - source-field: "siName"
        target-field: "applicableInstrumentSI.siName"
      - source-field: "weight"
        target-field: "applicableInstrumentSI.weight"
      - source-field: "confidenceLevel"
        target-field: "applicableInstrumentSI.confidenceLevel"
      - source-field: "defaultSettlementMethod"
        target-field: "applicableInstrumentSI.defaultSettlementMethod"
      - source-field: "defaultDeliveryInstruction"
        target-field: "applicableInstrumentSI.defaultDeliveryInstruction"
      - source-field: "typicalSettlementCycle"
        target-field: "enrichedTypicalSettlementCycle"

  # Counterparty Resolution Enrichment
  - id: "counterparty-resolution-enrichment"
    name: "Counterparty Resolution"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 400
    condition: "#instruction.counterpartyId == null && #instruction.market != null"
    lookup-config:
      lookup-key: "#instruction.market + '_' + #instruction.clientId"
      lookup-dataset:
        type: "inline"
        key-field: "marketAndClientKey"
        data:
          - marketAndClientKey: "JAPAN_CLIENT_A"
            counterpartyId: "CP_JAPAN_CLIENT_A"
            counterpartyName: "Japan Client A Counterparty"
            counterpartyBic: "JPCLIENTABIC"
            counterpartyAccount: "ACC_JP_CLIENT_A"
          - marketAndClientKey: "HONG_KONG_CLIENT_B"
            counterpartyId: "CP_HK_CLIENT_B"
            counterpartyName: "Hong Kong Client B Counterparty"
            counterpartyBic: "HKCLIENTBBIC"
            counterpartyAccount: "ACC_HK_CLIENT_B"
          - marketAndClientKey: "SINGAPORE_PREMIUM_CLIENT_X"
            counterpartyId: "CP_SG_PREMIUM_X"
            counterpartyName: "Singapore Premium Client X Counterparty"
            counterpartyBic: "SGPREMXBIC"
            counterpartyAccount: "ACC_SG_PREMIUM_X"
    field-mappings:
      - source-field: "counterpartyId"
        target-field: "resolvedCounterpartyId"
      - source-field: "counterpartyName"
        target-field: "resolvedCounterpartyName"
      - source-field: "counterpartyBic"
        target-field: "resolvedCounterpartyBic"
      - source-field: "counterpartyAccount"
        target-field: "resolvedCounterpartyAccount"

  # Custodial Account Assignment Enrichment
  - id: "custodial-account-enrichment"
    name: "Custodial Account Assignment"
    type: "lookup-enrichment"
    target-type: "SettlementInstruction"
    enabled: true
    priority: 500
    condition: "#instruction.custodianId != null && #instruction.safekeepingAccount == null"
    lookup-config:
      lookup-key: "#instruction.custodianId + '_' + #instruction.clientId"
      lookup-dataset:
        type: "inline"
        key-field: "custodianAndClientKey"
        data:
          - custodianAndClientKey: "CUST_CLIENT_A_CLIENT_A"
            safekeepingAccount: "SAFE_CLIENT_A_001"
            custodialAccount: "CUST_CLIENT_A_001"
            accountType: "SEGREGATED"
          - custodianAndClientKey: "CUST_PREMIUM_GLOBAL_PREMIUM_CLIENT_X"
            safekeepingAccount: "SAFE_PREMIUM_X_001"
            custodialAccount: "CUST_PREMIUM_X_001"
            accountType: "SEGREGATED_PREMIUM"
          - custodianAndClientKey: "CUST_JAPAN_DEFAULT_CLIENT_A"
            safekeepingAccount: "SAFE_JP_CLIENT_A_001"
            custodialAccount: "CUST_JP_CLIENT_A_001"
            accountType: "OMNIBUS"
    field-mappings:
      - source-field: "safekeepingAccount"
        target-field: "assignedSafekeepingAccount"
      - source-field: "custodialAccount"
        target-field: "assignedCustodialAccount"
      - source-field: "accountType"
        target-field: "assignedAccountType"
