# ============================================================================
# APEX Rules Engine - Dataset Enrichment Demonstration
# ============================================================================
#
# This YAML configuration showcases comprehensive dataset enrichment capabilities,
# demonstrating how to enhance data with reference information using various
# lookup patterns and enrichment strategies.
#
# OVERVIEW:
# This configuration demonstrates advanced data enrichment techniques that
# transform basic data records into rich, contextual information by adding
# reference data, calculated fields, and derived insights.
#
# ENRICHMENT STRATEGIES:
# 1. REFERENCE DATA LOOKUP - Static data enrichment
#    - Currency reference data (ISO codes, regions, symbols)
#    - Country information (timezones, tax rates, regulations)
#    - Customer tier classification (benefits, requirements)
#    - Product catalog information (categories, specifications)
#
# 2. CALCULATED ENRICHMENT - Dynamic field computation
#    - Age calculation from birth dates
#    - Discount rate computation based on multiple factors
#    - Risk scoring using weighted algorithms
#    - Performance metrics and KPI calculations
#
# 3. HIERARCHICAL ENRICHMENT - Multi-level data relationships
#    - Geographic hierarchy (country → region → timezone)
#    - Organizational structure (department → division → company)
#    - Product taxonomy (category → subcategory → product)
#
# DATASET TYPES DEMONSTRATED:
# - Inline datasets: Embedded reference data for fast lookups
# - External datasets: References to external data sources
# - Calculated datasets: Dynamic data generation using expressions
# - Hierarchical datasets: Multi-level relationship mapping
#
# BUSINESS USE CASES:
# - Customer data enrichment for personalization
# - Financial data enhancement for risk assessment
# - Geographic data augmentation for compliance
# - Product information enrichment for recommendations
# - Regulatory data addition for compliance reporting
#
# TECHNICAL FEATURES:
# - Multiple field mappings per enrichment
# - Conditional enrichment based on data availability
# - Dependency management between enrichments
# - Performance optimization for large datasets
# - Error handling for missing reference data
#
# INTEGRATION SCENARIOS:
# - CRM systems requiring customer context
# - E-commerce platforms needing product information
# - Financial systems requiring regulatory data
# - Analytics platforms needing dimensional data
# - Reporting systems requiring reference information
#
# ============================================================================

metadata:
  name: "Dataset Enrichment Demonstration"
  version: "1.0.0"
  description: "Comprehensive examples of YAML dataset enrichment capabilities"
  type: "rule-config"
  author: "dataset-demo@rulesengine.dev"
  created-by: "dataset-demo@rulesengine.dev"
  created-date: "2025-07-27"
  domain: "Data Enrichment"
  tags: ["datasets", "enrichment", "lookup", "reference-data"]

# ============================================================================
# VALIDATION RULES FOR ENRICHED DATA
# ============================================================================
#
# These validation rules demonstrate how to validate data that has been
# enriched with reference information. They show dependency management
# and how enriched fields can be used in validation logic.
#
# RULE DEPENDENCIES:
# - depends-on: Specifies which enrichments must complete before validation
# - Ensures enriched fields are available for validation logic
# - Enables complex validation scenarios using reference data
#
# ENRICHED FIELD VALIDATION PATTERNS:
# - Currency validation using enriched currency properties
# - Regional compliance using geographic reference data
# - Customer tier validation using enriched tier information
# - Product validation using catalog reference data
#
# VALIDATION SCENARIOS:
# - Cross-reference validation (currency active and tradeable)
# - Regional compliance (supported regions and jurisdictions)
# - Business rule validation (tier requirements and balances)
# - Data quality validation (completeness after enrichment)
#
rules:
  - id: "enriched-currency-validation"
    name: "Enriched Currency Validation"
    condition: "#currencyActive == true && #currencyTradeable == true"
    message: "Currency must be active and tradeable"
    severity: "ERROR"
    depends-on: ["currency-enrichment"]
    
  - id: "regional-compliance-check"
    name: "Regional Compliance Check"
    condition: "#currencyRegion != null && #currencyRegion in {'North America', 'Europe', 'Asia'}"
    message: "Currency region must be supported"
    severity: "WARNING"
    depends-on: ["currency-enrichment"]
    
  - id: "customer-tier-validation"
    name: "Customer Tier Validation"
    condition: "#customerTierName != null && #customerTierMinBalance <= #accountBalance"
    message: "Account balance must meet minimum tier requirement"
    severity: "ERROR"
    depends-on: ["customer-tier-enrichment"]

# ============================================================================
# COMPREHENSIVE ENRICHMENT EXAMPLES
# ============================================================================
#
# This section demonstrates various enrichment patterns and techniques
# for adding reference data, calculated fields, and derived insights
# to your data records.
#
# ENRICHMENT TYPES:
# 1. LOOKUP ENRICHMENT - Reference data addition
#    - Static reference data from inline datasets
#    - Multiple field mappings per lookup
#    - Conditional enrichment based on data availability
#
# 2. CALCULATION ENRICHMENT - Dynamic field computation
#    - Mathematical calculations using SpEL expressions
#    - Date/time calculations and transformations
#    - Business logic implementation through expressions
#
# 3. HIERARCHICAL ENRICHMENT - Multi-level data relationships
#    - Geographic hierarchies (country → region → timezone)
#    - Organizational structures (department → division)
#    - Product taxonomies (category → subcategory)
#
# DATASET FEATURES:
# - Inline datasets: Fast, embedded reference data
# - Key-field matching: Efficient lookup mechanisms
# - Multiple field mappings: Comprehensive data enhancement
# - Conditional logic: Smart enrichment based on context
#
# PERFORMANCE CONSIDERATIONS:
# - Inline datasets for frequently accessed reference data
# - Optimized key-field indexing for fast lookups
# - Conditional enrichment to avoid unnecessary processing
# - Field mapping optimization for memory efficiency
#
enrichments:
  # Currency reference data enrichment
  - id: "currency-enrichment"
    type: "lookup-enrichment"
    description: "Enrich currency codes with comprehensive reference data"
    condition: "['currency'] != null"
    lookup-config:
      lookup-key: "currency"
      lookup-dataset:
        type: "inline"
        key-field: "code"
        data:
          - code: "USD"
            name: "US Dollar"
            symbol: "$"
            region: "North America"
            country: "United States"
            decimalPlaces: 2
            active: true
            tradeable: true
            majorCurrency: true
            centralBank: "Federal Reserve"
            isoNumeric: 840
          - code: "EUR"
            name: "Euro"
            symbol: "€"
            region: "Europe"
            country: "Eurozone"
            decimalPlaces: 2
            active: true
            tradeable: true
            majorCurrency: true
            centralBank: "European Central Bank"
            isoNumeric: 978
          - code: "GBP"
            name: "British Pound"
            symbol: "£"
            region: "Europe"
            country: "United Kingdom"
            decimalPlaces: 2
            active: true
            tradeable: true
            majorCurrency: true
            centralBank: "Bank of England"
            isoNumeric: 826
          - code: "JPY"
            name: "Japanese Yen"
            symbol: "¥"
            region: "Asia"
            country: "Japan"
            decimalPlaces: 0
            active: true
            tradeable: true
            majorCurrency: true
            centralBank: "Bank of Japan"
            isoNumeric: 392
          - code: "CHF"
            name: "Swiss Franc"
            symbol: "CHF"
            region: "Europe"
            country: "Switzerland"
            decimalPlaces: 2
            active: true
            tradeable: true
            majorCurrency: false
            centralBank: "Swiss National Bank"
            isoNumeric: 756
          - code: "CAD"
            name: "Canadian Dollar"
            symbol: "C$"
            region: "North America"
            country: "Canada"
            decimalPlaces: 2
            active: true
            tradeable: true
            majorCurrency: false
            centralBank: "Bank of Canada"
            isoNumeric: 124
    field-mappings:
      - source-field: "name"
        target-field: "currencyName"
      - source-field: "symbol"
        target-field: "currencySymbol"
      - source-field: "region"
        target-field: "currencyRegion"
      - source-field: "country"
        target-field: "currencyCountry"
      - source-field: "decimalPlaces"
        target-field: "currencyDecimalPlaces"
      - source-field: "active"
        target-field: "currencyActive"
      - source-field: "tradeable"
        target-field: "currencyTradeable"
      - source-field: "majorCurrency"
        target-field: "currencyMajor"
      - source-field: "centralBank"
        target-field: "currencyCentralBank"
      - source-field: "isoNumeric"
        target-field: "currencyIsoNumeric"

  # Country/Region enrichment
  - id: "country-enrichment"
    type: "lookup-enrichment"
    description: "Enrich country codes with regional and regulatory information"
    condition: "['countryCode'] != null"
    lookup-config:
      lookup-key: "countryCode"
      lookup-dataset:
        type: "inline"
        key-field: "code"
        data:
          - code: "US"
            name: "United States"
            region: "North America"
            continent: "North America"
            regulatoryRegime: "CFTC"
            timeZone: "Multiple"
            language: "English"
            gdpRanking: 1
            financialCenter: true
          - code: "GB"
            name: "United Kingdom"
            region: "Europe"
            continent: "Europe"
            regulatoryRegime: "FCA"
            timeZone: "GMT"
            language: "English"
            gdpRanking: 6
            financialCenter: true
          - code: "DE"
            name: "Germany"
            region: "Europe"
            continent: "Europe"
            regulatoryRegime: "ESMA"
            timeZone: "CET"
            language: "German"
            gdpRanking: 4
            financialCenter: true
          - code: "JP"
            name: "Japan"
            region: "Asia"
            continent: "Asia"
            regulatoryRegime: "JFSA"
            timeZone: "JST"
            language: "Japanese"
            gdpRanking: 3
            financialCenter: true
    field-mappings:
      - source-field: "name"
        target-field: "countryName"
      - source-field: "region"
        target-field: "countryRegion"
      - source-field: "continent"
        target-field: "countryContinent"
      - source-field: "regulatoryRegime"
        target-field: "countryRegulatoryRegime"
      - source-field: "timeZone"
        target-field: "countryTimeZone"
      - source-field: "language"
        target-field: "countryLanguage"
      - source-field: "gdpRanking"
        target-field: "countryGdpRanking"
      - source-field: "financialCenter"
        target-field: "countryFinancialCenter"

  # Customer tier enrichment
  - id: "customer-tier-enrichment"
    type: "lookup-enrichment"
    description: "Enrich customer tier codes with benefits and requirements"
    condition: "['customerTier'] != null"
    lookup-config:
      lookup-key: "customerTier"
      lookup-dataset:
        type: "inline"
        key-field: "tier"
        data:
          - tier: "BASIC"
            name: "Basic Customer"
            description: "Entry-level customer tier"
            minBalance: 0
            maxTransactionLimit: 10000
            feeDiscount: 0.0
            prioritySupport: false
            dedicatedManager: false
            benefits: ["Basic trading", "Standard support"]
          - tier: "SILVER"
            name: "Silver Customer"
            description: "Mid-tier customer with enhanced benefits"
            minBalance: 50000
            maxTransactionLimit: 100000
            feeDiscount: 0.05
            prioritySupport: true
            dedicatedManager: false
            benefits: ["Reduced fees", "Priority support", "Extended trading hours"]
          - tier: "GOLD"
            name: "Gold Customer"
            description: "High-value customer with premium benefits"
            minBalance: 250000
            maxTransactionLimit: 1000000
            feeDiscount: 0.10
            prioritySupport: true
            dedicatedManager: true
            benefits: ["Significant fee reduction", "Dedicated manager", "Premium research"]
          - tier: "PLATINUM"
            name: "Platinum Customer"
            description: "Ultra-high-net-worth customer tier"
            minBalance: 1000000
            maxTransactionLimit: 10000000
            feeDiscount: 0.15
            prioritySupport: true
            dedicatedManager: true
            benefits: ["Maximum fee discount", "White-glove service", "Exclusive products"]
    field-mappings:
      - source-field: "name"
        target-field: "customerTierName"
      - source-field: "description"
        target-field: "customerTierDescription"
      - source-field: "minBalance"
        target-field: "customerTierMinBalance"
      - source-field: "maxTransactionLimit"
        target-field: "customerTierMaxTransaction"
      - source-field: "feeDiscount"
        target-field: "customerTierFeeDiscount"
      - source-field: "prioritySupport"
        target-field: "customerTierPrioritySupport"
      - source-field: "dedicatedManager"
        target-field: "customerTierDedicatedManager"
      - source-field: "benefits"
        target-field: "customerTierBenefits"

  # Product category enrichment
  - id: "product-category-enrichment"
    type: "lookup-enrichment"
    description: "Enrich product categories with risk and regulatory information"
    condition: "['productCategory'] != null"
    lookup-config:
      lookup-key: "productCategory"
      lookup-dataset:
        type: "inline"
        key-field: "category"
        data:
          - category: "EQUITY"
            name: "Equity Securities"
            description: "Stocks, shares, and equity derivatives"
            riskLevel: "MEDIUM"
            regulatoryCategory: "SECURITIES"
            marginRequirement: 0.25
            liquidityRating: "HIGH"
            tradingHours: "09:30-16:00"
          - category: "FIXED_INCOME"
            name: "Fixed Income"
            description: "Bonds, notes, and fixed income derivatives"
            riskLevel: "LOW"
            regulatoryCategory: "SECURITIES"
            marginRequirement: 0.10
            liquidityRating: "HIGH"
            tradingHours: "08:00-17:00"
          - category: "COMMODITY"
            name: "Commodities"
            description: "Physical commodities and commodity derivatives"
            riskLevel: "HIGH"
            regulatoryCategory: "DERIVATIVES"
            marginRequirement: 0.15
            liquidityRating: "MEDIUM"
            tradingHours: "24/5"
          - category: "FX"
            name: "Foreign Exchange"
            description: "Currency pairs and FX derivatives"
            riskLevel: "HIGH"
            regulatoryCategory: "FX"
            marginRequirement: 0.05
            liquidityRating: "VERY_HIGH"
            tradingHours: "24/5"
    field-mappings:
      - source-field: "name"
        target-field: "productCategoryName"
      - source-field: "description"
        target-field: "productCategoryDescription"
      - source-field: "riskLevel"
        target-field: "productCategoryRiskLevel"
      - source-field: "regulatoryCategory"
        target-field: "productCategoryRegulatoryCategory"
      - source-field: "marginRequirement"
        target-field: "productCategoryMarginRequirement"
      - source-field: "liquidityRating"
        target-field: "productCategoryLiquidityRating"
      - source-field: "tradingHours"
        target-field: "productCategoryTradingHours"

  # Conditional enrichment example - only for high-value transactions
  - id: "high-value-transaction-enrichment"
    type: "lookup-enrichment"
    description: "Additional enrichment for high-value transactions"
    condition: "['transactionAmount'] != null && ['transactionAmount'] > 1000000"
    lookup-config:
      lookup-key: "'HIGH_VALUE'"
      lookup-dataset:
        type: "inline"
        key-field: "type"
        data:
          - type: "HIGH_VALUE"
            name: "High Value Transaction"
            description: "Transaction exceeds $1M threshold"
            requiresApproval: true
            approvalLevel: "SENIOR_MANAGER"
            additionalReporting: true
            enhancedMonitoring: true
            complianceReview: true
    field-mappings:
      - source-field: "name"
        target-field: "transactionTypeName"
      - source-field: "description"
        target-field: "transactionTypeDescription"
      - source-field: "requiresApproval"
        target-field: "transactionRequiresApproval"
      - source-field: "approvalLevel"
        target-field: "transactionApprovalLevel"
      - source-field: "additionalReporting"
        target-field: "transactionAdditionalReporting"
      - source-field: "enhancedMonitoring"
        target-field: "transactionEnhancedMonitoring"
      - source-field: "complianceReview"
        target-field: "transactionComplianceReview"
