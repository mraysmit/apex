metadata:
  id: "comprehensive-financial-settlement-demo"
  name: "Comprehensive Financial Settlement Demo"
  description: "Multi-asset settlement processing with cross-border and high-value transaction support"
  version: "1.0.0"
  author: "APEX Demo Team"

enrichments:
  - id: "settlement-type-classification"
    name: "Settlement Type Classification"
    description: "Classifies settlement based on asset types and transaction characteristics"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        #assetClass != null && #assetClass.equals('EQUITY') ? 'EQUITY_SETTLEMENT' :
        #assetClass != null && #assetClass.equals('BOND') ? 'FIXED_INCOME_SETTLEMENT' :
        #assetClass != null && #assetClass.equals('FX') ? 'FX_SETTLEMENT' :
        #assetClass != null && #assetClass.equals('COMMODITY') ? 'COMMODITY_SETTLEMENT' :
        'MULTI_ASSET_SETTLEMENT'
      result-field: "settlementType"
    field-mappings:
      - source-field: "settlementType"
        target-field: "settlementType"

  - id: "settlement-priority-calculation"
    name: "Settlement Priority Calculation"
    description: "Calculates settlement priority based on amount and urgency"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        #quantity != null && #quantity > 10000000 ? 'HIGH_PRIORITY' :
        #quantity != null && #quantity > 1000000 ? 'MEDIUM_PRIORITY' :
        'STANDARD_PRIORITY'
      result-field: "settlementPriority"
    field-mappings:
      - source-field: "settlementPriority"
        target-field: "settlementPriority"

  - id: "settlement-processing-summary"
    name: "Settlement Processing Summary"
    description: "Generates comprehensive settlement processing summary"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        'Settlement processed for ' +
        (#assetClass != null ? #assetClass : 'UNKNOWN') +
        ' trade ' +
        (#tradeId != null ? #tradeId : 'UNKNOWN') +
        ' - Market: ' +
        (#market != null ? #market : 'UNKNOWN') +
        ' - Status: PROCESSED'
      result-field: "settlementResult"
    field-mappings:
      - source-field: "settlementResult"
        target-field: "settlementResult"

  - id: "risk-assessment-enrichment"
    name: "Risk Assessment Enrichment"
    description: "Assesses settlement risk based on counterparty and amount"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        #counterparty != null && #counterparty.contains('Goldman') ? 'LOW_RISK' :
        #counterparty != null && #counterparty.contains('JPMorgan') ? 'LOW_RISK' :
        #counterparty != null && #counterparty.contains('Deutsche') ? 'MEDIUM_RISK' :
        'HIGH_RISK'
      result-field: "riskAssessment"
    field-mappings:
      - source-field: "riskAssessment"
        target-field: "riskAssessment"

  - id: "settlement-convention-enrichment"
    name: "Settlement Convention Enrichment"
    description: "Determines settlement convention based on market"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        #market != null && #market.equals('UK') ? 'T+2' :
        #market != null && #market.equals('US') ? 'T+2' :
        #market != null && #market.equals('GERMANY') ? 'T+2' :
        'T+3'
      result-field: "settlementConvention"
    field-mappings:
      - source-field: "settlementConvention"
        target-field: "settlementConvention"

  - id: "regulatory-compliance-enrichment"
    name: "Regulatory Compliance Enrichment"
    description: "Determines regulatory compliance requirements based on market"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        #market != null && #market.equals('UK') ? 'FCA_COMPLIANCE_REQUIRED' :
        #market != null && #market.equals('US') ? 'SEC_COMPLIANCE_REQUIRED' :
        #market != null && #market.equals('GERMANY') ? 'BAFIN_COMPLIANCE_REQUIRED' :
        'STANDARD_COMPLIANCE'
      result-field: "regulatoryCompliance"
    field-mappings:
      - source-field: "regulatoryCompliance"
        target-field: "regulatoryCompliance"

  - id: "currency-conversion-enrichment"
    name: "Currency Conversion Enrichment"
    description: "Determines currency conversion requirements"
    type: "calculation-enrichment"
    calculation-config:
      expression: |
        #currency != null && #targetCurrency != null && !#currency.equals(#targetCurrency) ?
        (#currency + '/' + #targetCurrency + ' conversion required - Rate: ' +
        (#currency.equals('GBP') && #targetCurrency.equals('USD') ? '1.25' :
         #currency.equals('USD') && #targetCurrency.equals('EUR') ? '0.85' :
         #currency.equals('EUR') && #targetCurrency.equals('USD') ? '1.18' : '1.00')) :
        'NO_CONVERSION_REQUIRED'
      result-field: "currencyConversion"
    field-mappings:
      - source-field: "currencyConversion"
        target-field: "currencyConversion"

rules:
  - id: "settlement-amount-validation"
    name: "Settlement Amount Validation"
    description: "Validates settlement amount is positive and within limits"
    type: "validation-rule"
    condition: "#settlementAmount != null && #settlementAmount > 0 && #settlementAmount <= 100000000"
    error-message: "Settlement amount must be positive and not exceed $100M"
    severity: "ERROR"

  - id: "counterparty-validation"
    name: "Counterparty Validation"
    description: "Validates counterparty information is complete"
    type: "validation-rule"
    condition: "#counterpartyId != null && #counterpartyId.length() > 0"
    error-message: "Counterparty ID is required for settlement processing"
    severity: "ERROR"

  - id: "asset-type-validation"
    name: "Asset Type Validation"
    description: "Validates asset type is supported"
    type: "validation-rule"
    condition: "#assetType != null && (#assetType.equals('EQUITY') || #assetType.equals('BOND') || #assetType.equals('FX') || #assetType.equals('COMMODITY'))"
    error-message: "Asset type must be one of: EQUITY, BOND, FX, COMMODITY"
    severity: "ERROR"

rule-groups:
  - id: "settlement-validation-group"
    name: "Settlement Validation Group"
    description: "Comprehensive settlement validation rules"
    type: "and-group"
    rules:
      - "settlement-amount-validation"
      - "counterparty-validation"
      - "asset-type-validation"

  - id: "settlement-enrichment-group"
    name: "Settlement Enrichment Group"
    description: "Settlement processing enrichments"
    type: "sequential-group"
    rules:
      - "settlement-type-classification"
      - "settlement-priority-calculation"
      - "risk-assessment-enrichment"
      - "settlement-processing-summary"
