# Self-Contained Database Data Source Configuration
# Demonstrates external database data source using embedded H2 database (PostgreSQL compatible mode)
# Use Case: Customer profile data source for enrichment lookups

# ============================================================================
# APEX YAML Configuration File
# ============================================================================
# Used by: ORPHANED - No Java test currently uses this file
# Purpose: PostgreSQL simple lookup demonstration using APEX lookup enrichments
#          with basic PostgreSQL database integration and simple lookup operations
# Status: Available for integration with PostgreSQL simple lookup tests
# ============================================================================

metadata:
  id: "self-contained-database-data-source-demo"
  name: "Self-Contained Database Data Source Demo"
  version: "1.0.0"
  description: "Data source configuration for embedded H2 database with connection pooling and caching"
  type: "external-data-config"
  author: "apex.demo.team@company.com"
  created-date: "2024-12-24"
  tags: ["apex-demo", "lookup", "database", "data-source"]

# External data source configuration
data-sources:
  - name: "customer-database"
    type: "database"
    source-type: "h2"
    enabled: true
    description: "Customer master data from self-contained H2 database"

    connection:
      # H2 file-based database for true sharing between demo and APEX
      database: "./target/h2-demo/apex_demo_shared"
      username: "sa"
      password: ""

      # Connection pool configuration (verified against YamlDataSource.java)
      connection-pool:
        max-size: 20
        min-size: 5
        initial-size: 5
        connection-timeout: 30000
        idle-timeout: 600000
        max-lifetime: 1800000
        leak-detection-threshold: 60000
        connection-test-query: "SELECT 1"
        test-on-borrow: true
        test-while-idle: true
        
    # Caching configuration for performance
    cache:
      enabled: true
      ttlSeconds: 3600  # 1 hour cache
      maxSize: 10000

    # Health check configuration
    healthCheck:
      enabled: true
      query: "SELECT 1"
      intervalSeconds: 30
      timeoutSeconds: 5
      
    # Database initialization (for demo purposes)
    initialization:
      enabled: true
      scripts:
        - |
          CREATE TABLE IF NOT EXISTS customers (
            customer_id VARCHAR(20) PRIMARY KEY,
            customer_name VARCHAR(100) NOT NULL,
            customer_type VARCHAR(20) NOT NULL,
            tier VARCHAR(20) NOT NULL,
            region VARCHAR(10) NOT NULL,
            status VARCHAR(20) NOT NULL,
            created_date DATE,
            last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
        - |
          INSERT INTO customers (customer_id, customer_name, customer_type, tier, region, status, created_date) VALUES
          ('CUST000001', 'Acme Corporation', 'CORPORATE', 'PLATINUM', 'NA', 'ACTIVE', '2023-01-15'),
          ('CUST000002', 'Beta Industries', 'CORPORATE', 'GOLD', 'EU', 'ACTIVE', '2023-02-20'),
          ('CUST000003', 'Gamma Holdings', 'INSTITUTIONAL', 'PLATINUM', 'APAC', 'ACTIVE', '2023-03-10'),
          ('CUST000004', 'Delta Partners', 'CORPORATE', 'SILVER', 'NA', 'ACTIVE', '2023-04-05'),
          ('CUST000005', 'Epsilon Fund', 'INSTITUTIONAL', 'GOLD', 'EU', 'ACTIVE', '2023-05-12');

    # Query definitions for this data source
    queries:
      customerProfile: "SELECT customer_id, customer_name, customer_type, tier, region, status, created_date, last_updated FROM customers WHERE customer_id = :customerId"

    # Parameter definitions
    parameterNames:
      - "customerId"

# Enrichment rules using database lookups
enrichments:
  - id: "self-contained-database-data-source-demo"
    name: "customer-profile-simple-lookup"
    description: "Simple customer profile lookup using H2 database"
    type: "lookup-enrichment"

    # Condition: Only process if customerId is present
    condition: "#customerId != null && #customerId != ''"

    # Database lookup configuration
    lookup-config:
      lookup-key: "#customerId"
      lookup-dataset:
        type: "database"
        connection-name: "customer-database"
        query: "SELECT customer_name, customer_type, tier, region, status, created_date FROM customers WHERE customer_id = :customerId"
        parameters:
          - field: "customerId"
            type: "string"

    # Field mappings for enrichment results (H2 returns uppercase column names)
    field-mappings:
      - source-field: "CUSTOMER_NAME"
        target-field: "customerName"
        required: true
      - source-field: "CUSTOMER_TYPE"
        target-field: "customerType"
        required: true
      - source-field: "TIER"
        target-field: "customerTier"
        required: true
      - source-field: "REGION"
        target-field: "customerRegion"
        required: true
      - source-field: "STATUS"
        target-field: "customerStatus"
        required: true
      - source-field: "CREATED_DATE"
        target-field: "customerCreatedDate"
        required: false