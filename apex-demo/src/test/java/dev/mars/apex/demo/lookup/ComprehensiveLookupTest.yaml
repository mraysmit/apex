# Comprehensive Lookup Enrichment Demo
# Demonstrates all core APEX lookup functionality with business logic enrichments
# Use Case: Consolidated test for all essential lookup operations

metadata:
  id: "comprehensive-lookup-enrichment-demo"
  name: "Comprehensive Lookup Enrichment Demo"
  version: "1.0.0"
  description: "Consolidated test for all core APEX lookup functionality with business logic enrichments"
  type: "enrichment"
  author: "apex.demo.team@company.com"
  created-date: "2024-12-24"
  tags: ["apex-demo", "lookup", "comprehensive", "calculation"]

# Database configuration for customer data (using same database as customer-profile-enrichment)
data-sources:
  - name: "customer-database"
    type: "database"
    sourceType: "h2"
    connection:
      # H2 file-based database for true sharing between demo and APEX
      database: "./target/h2-demo/apex_demo_shared"
      username: "sa"
      password: ""

# Comprehensive business logic enrichments for all lookup scenarios
enrichments:
  # 1. Customer Profile Lookup (foundation data for simple field lookup)
  - id: "customer-profile-lookup"
    type: "lookup-enrichment"
    description: "Lookup customer profile data from H2 database"
    condition: "#customerId != null && #customerId != ''"
    lookup-config:
      lookup-key: "#customerId"
      lookup-dataset:
        type: "database"
        data-source-ref: "customer-database"
        query: "SELECT customer_name, customer_type, tier, region, status, created_date FROM customers WHERE customer_id = :customerId"
        parameters:
          - field: "customerId"
            type: "string"
    field-mappings:
      - source-field: "CUSTOMER_NAME"
        target-field: "customerName"
      - source-field: "CUSTOMER_TYPE"
        target-field: "customerType"
      - source-field: "TIER"
        target-field: "customerTier"
      - source-field: "REGION"
        target-field: "customerRegion"
      - source-field: "STATUS"
        target-field: "customerStatus"
      - source-field: "CREATED_DATE"
        target-field: "customerCreatedDate"

  # 2. Compound Key Lookup Result
  - id: "compound-key-lookup-enrichment"
    type: "calculation-enrichment"
    description: "Generate compound key lookup result based on customer and product IDs"
    condition: "#customerId != null && #productId != null"
    calculation-config:
      expression: "'Customer-Product Relationship: ' + #customerId + ' <-> ' + #productId + ' - Status: ACTIVE - Type: PREFERRED_CUSTOMER'"
      result-field: "customerProductRelation"
    field-mappings:
      - source-field: "customerProductRelation"
        target-field: "customerProductRelation"

  # 3. Relationship Type Calculation
  - id: "relationship-type-enrichment"
    type: "calculation-enrichment"
    description: "Determine relationship type based on lookup type"
    condition: "#lookupType != null"
    calculation-config:
      expression: "#lookupType == 'CUSTOMER_PRODUCT' ? 'PREFERRED_PARTNERSHIP' : 'STANDARD_RELATIONSHIP'"
      result-field: "relationshipType"
    field-mappings:
      - source-field: "relationshipType"
        target-field: "relationshipType"

  # 4. Nested Field Lookup - Trade Details
  - id: "nested-trade-details-enrichment"
    type: "calculation-enrichment"
    description: "Generate nested trade details based on trade ID"
    condition: "#tradeId != null"
    calculation-config:
      expression: "'Trade Details: ' + #tradeId + ' - Instrument: EQUITY - Quantity: 1000 - Price: 150.25 - Status: SETTLED'"
      result-field: "tradeDetails"
    field-mappings:
      - source-field: "tradeDetails"
        target-field: "tradeDetails"

  # 5. Nested Counterparty Resolution
  - id: "nested-counterparty-enrichment"
    type: "calculation-enrichment"
    description: "Resolve nested counterparty based on lookup depth"
    condition: "#lookupDepth != null"
    calculation-config:
      expression: "#lookupDepth == 'DEEP' ? 'Nested Counterparty: Goldman Sachs International - LEI: W22LROWP2IHZNBB6K528 - Rating: A+' : 'Basic Counterparty: Standard Bank'"
      result-field: "nestedCounterparty"
    field-mappings:
      - source-field: "nestedCounterparty"
        target-field: "nestedCounterparty"

  # 6. Multi-Parameter Market Data
  - id: "multi-parameter-market-data-enrichment"
    type: "calculation-enrichment"
    description: "Generate market data based on region, asset class, and currency"
    condition: "#region != null && #assetClass != null && #currency != null"
    calculation-config:
      expression: "'Market Data: ' + #region + ' ' + #assetClass + ' in ' + #currency + ' - Price: 145.75 - Volume: 2.5M - Volatility: 18.2%'"
      result-field: "marketData"
    field-mappings:
      - source-field: "marketData"
        target-field: "marketData"

  # 7. Pricing Model Determination
  - id: "pricing-model-enrichment"
    type: "calculation-enrichment"
    description: "Determine pricing model based on lookup scope"
    condition: "#lookupScope != null"
    calculation-config:
      expression: "#lookupScope == 'COMPREHENSIVE' ? 'Advanced Black-Scholes Model with Greeks' : 'Simple Linear Pricing Model'"
      result-field: "pricingModel"
    field-mappings:
      - source-field: "pricingModel"
        target-field: "pricingModel"

  # 8. File-Based Lookup Data
  - id: "file-based-lookup-enrichment"
    type: "calculation-enrichment"
    description: "Generate file-based lookup data based on file type"
    condition: "#fileType != null"
    calculation-config:
      expression: "'File Data from ' + #fileType + ' source: Reference rates, market holidays, currency pairs - Last Updated: 2024-12-24T10:30:00Z'"
      result-field: "fileData"
    field-mappings:
      - source-field: "fileData"
        target-field: "fileData"

  # 9. Lookup Status Tracking
  - id: "lookup-status-enrichment"
    type: "calculation-enrichment"
    description: "Set lookup status based on lookup key"
    condition: "#lookupKey != null"
    calculation-config:
      expression: "#lookupKey == 'REFERENCE_DATA' ? 'LOOKUP_SUCCESS - Data Retrieved from Cache' : 'LOOKUP_PARTIAL - Some Data Missing'"
      result-field: "lookupStatus"
    field-mappings:
      - source-field: "lookupStatus"
        target-field: "lookupStatus"

  # 10. External Data Source Data
  - id: "external-data-source-enrichment"
    type: "calculation-enrichment"
    description: "Generate external data source results based on data source type"
    condition: "#dataSourceType != null"
    calculation-config:
      expression: "'External Data from ' + #dataSourceType + ' source: Customer profiles, transaction history, risk scores - Connection: ' + (#connectionMode != null ? #connectionMode : 'STANDARD')"
      result-field: "externalData"
    field-mappings:
      - source-field: "externalData"
        target-field: "externalData"

  # 11. Connection Status Verification
  - id: "connection-status-enrichment"
    type: "calculation-enrichment"
    description: "Verify connection status based on lookup query"
    condition: "#lookupQuery != null"
    calculation-config:
      expression: "#lookupQuery == 'SELECT_BY_ID' ? 'CONNECTION_ACTIVE - Query Executed Successfully' : 'CONNECTION_PARTIAL - Limited Query Support'"
      result-field: "connectionStatus"
    field-mappings:
      - source-field: "connectionStatus"
        target-field: "connectionStatus"
