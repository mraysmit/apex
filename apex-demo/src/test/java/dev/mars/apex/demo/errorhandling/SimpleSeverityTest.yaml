# ============================================================================
# APEX SEVERITY DEMONSTRATION: RULE SEVERITY LEVELS AND FAILURE POLICY INTERACTIONS
# ============================================================================
#
# PURPOSE:
# This configuration is used by SimpleSeverityTest.java to demonstrate how
# different rule severity levels (ERROR, WARNING, INFO) interact with
# stage-level failure policies in APEX.
#
# KEY CONCEPTS DEMONSTRATED:
# 1. Rule Severity Levels:
#    - ERROR: Critical failures that cause stage failure
#    - WARNING: Issues that should be logged but don't fail the stage
#    - INFO: Informational messages for audit trails
#
# 2. Stage Failure Policy Interaction:
#    - ERROR rules trigger failure policies (terminate/continue-with-warnings/flag-for-review)
#    - WARNING rules log warnings but don't trigger failure policies
#    - INFO rules provide audit information without affecting processing
#
# 3. Rule Groups:
#    - Critical validation group: All ERROR rules must pass
#    - Warning checks group: Collects WARNING messages
#    - Info audit group: Provides informational logging
#
# BUSINESS SCENARIOS:
# - Critical validations: Must pass or processing fails
# - Business warnings: Log issues but continue processing
# - Audit information: Track processing for compliance
#
# USED BY:
# SimpleSeverityTest.java - demonstrates severity level handling
#
# ============================================================================

metadata:
  id: "severity-failure-policy-examples"
  name: "Severity and Failure Policy Examples"
  version: "1.0.0"
  description: "Examples showing rule severity and stage failure policy interactions"
  type: "rule-config"
  author: "APEX Investigation"

# Mixed severity validation rules
rules:
  # Critical Error Rules (severity: ERROR) - These cause stage failure
  - id: "critical-amount-validation"
    name: "Critical Amount Validation"
    description: "Amount must be positive - critical error"
    condition: "#data.amount != null && T(java.lang.Double).parseDouble(#data.amount.toString()) > 0"
    message: "CRITICAL: Amount must be positive, got: {{#data.amount}}"
    severity: "ERROR"
    priority: 1
    enabled: true
    
  - id: "mandatory-field-validation"
    name: "Mandatory Field Validation"
    description: "Trade ID must be present - critical error"
    condition: "#data.tradeId != null && !#data.tradeId.toString().isEmpty()"
    message: "CRITICAL: Trade ID is mandatory"
    severity: "ERROR"
    priority: 1
    enabled: true
    
  # Business Warning Rules (severity: WARNING) - These log warnings but don't fail stage
  - id: "unusual-amount-warning"
    name: "Unusual Amount Warning"
    description: "Amount is unusually high - warning"
    condition: "#data.amount == null || T(java.lang.Double).parseDouble(#data.amount.toString()) <= 1000000"
    message: "WARNING: Amount {{#data.amount}} is unusually high - please verify"
    severity: "WARNING"
    priority: 2
    enabled: true
    
  - id: "missing-optional-field-warning"
    name: "Missing Optional Field Warning"
    description: "Optional reference field is missing - warning"
    condition: "#data.reference == null || true"  # Always passes but demonstrates warning usage
    message: "WARNING: Optional reference field is missing"
    severity: "WARNING" 
    priority: 3
    enabled: true
    
  # Informational Rules (severity: INFO) - These provide information only
  - id: "processing-audit-info"
    name: "Processing Audit Info"
    description: "Audit information for processing"
    condition: "true"  # Always matches for demonstration
    message: "INFO: Trade processed at {{T(java.time.Instant).now()}}"
    severity: "INFO"
    priority: 4
    enabled: true

# Enrichments to create status field for testing
enrichments:
  - id: "severity-status-enrichment"
    name: "Severity Status Enrichment"
    description: "Creates status field based on amount validation"
    type: "calculation-enrichment"
    calculation-config:
      # Simple validation that creates a status field
      expression: "(#amount != null && #amount > 0) ? 'VALID' : 'INVALID'"
      result-field: "validation-result"  # Internal field name
    field-mappings:
      - source-field: "validation-result"  # Map from internal field
        target-field: "status"             # To expected output field

# Rule groups demonstrating different behaviors
rule-groups:
  - id: "critical-validation-group"
    name: "Critical Validation Group"
    description: "GROUP: Critical validations - any ERROR causes stage failure"
    operator: "AND"  # All rules must pass
    rules:
      - "critical-amount-validation"
      - "mandatory-field-validation"
    stop-on-first-failure: true  # Stop at first ERROR

  - id: "warning-checks-group"
    name: "Warning Checks Group"
    description: "GROUP: Warning checks - continue even with warnings"
    operator: "OR"  # Any rule can match to trigger warnings
    rules:
      - "unusual-amount-warning"
      - "missing-optional-field-warning"
    stop-on-first-failure: false  # Continue processing all warnings

  - id: "info-audit-group"
    name: "Information Audit Group"
    description: "GROUP: Informational rules for audit trail"
    operator: "OR"
    rules:
      - "processing-audit-info"
    stop-on-first-failure: false