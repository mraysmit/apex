# Enhanced REST API Demo Configuration
# Demonstrates REST API-style lookup functionality using APEX enrichments
# Note: Since APEX doesn't support REST API data sources directly,
# this demo uses inline data to simulate REST API responses
# while maintaining YAML First principles

# ============================================================================
# APEX YAML Configuration File
# ============================================================================
# Used by: EnhancedRestApiDemoTest.java (Converted to YAML First approach)
# Purpose: Simulated REST API lookup demonstration using APEX lookup
#          enrichments with inline data that represents REST API responses
# Status: ACTIVE - Converted from direct HTTP client to YAML First approach
# ============================================================================

metadata:
  id: "enhanced-rest-api-demo"
  name: "Enhanced REST API Demo"
  version: "2.0.0"
  description: "Demonstrates REST API-style lookup functionality using real REST API data sources"
  type: "enrichment"
  author: "apex.demo.team@company.com"
  created-date: "2024-12-24"
  tags: ["apex-demo", "lookup", "rest-api", "currency", "market-data", "metrics"]

# Define REST API data sources
data-sources:
  - name: "enhanced-currency-api"
    type: "rest-api"
    description: "Enhanced Currency Rates API"
    connection:
      base-url: "http://localhost:${PORT}"
      timeout: 5000
      headers:
        Content-Type: "application/json"
        Accept: "application/json"
    endpoints:
      currency-rates: "/api/v2/currency/rates"

  - name: "market-data-api"
    type: "rest-api"
    description: "Market Data API"
    connection:
      base-url: "http://localhost:${PORT}"
      timeout: 5000
      headers:
        Content-Type: "application/json"
        Accept: "application/json"
    endpoints:
      market-data: "/api/v2/market/data?symbol={symbol}"

  - name: "metrics-api"
    type: "rest-api"
    description: "Server Metrics API"
    connection:
      base-url: "http://localhost:${PORT}"
      timeout: 5000
      headers:
        Content-Type: "application/json"
        Accept: "application/json"
    endpoints:
      metrics: "/api/v2/metrics"

# Define the enrichment rules for REST API lookup
enrichments:
  - id: "enhanced-currency-rates-lookup"
    name: "Enhanced Currency Rates Lookup"
    description: "Enrich data with currency rates from REST API"
    type: "lookup-enrichment"
    enabled: true
    condition: "#lookupType == 'currency'"

    lookup-config:
      lookup-key: "#lookupType"
      lookup-dataset:
        type: "rest-api"
        data-source-ref: "enhanced-currency-api"
        operation-ref: "currency-rates"
        parameters:
          - field: "lookupType"
            name: "lookupType"
            type: "string"
    field-mappings:
      - source-field: "source"
        target-field: "source"
        required: true
      - source-field: "version"
        target-field: "version"
        required: true
      - source-field: "timestamp"
        target-field: "timestamp"
        required: true
      - source-field: "totalRates"
        target-field: "totalRates"
        required: true
      - source-field: "currencyRates"
        target-field: "currencyRates"
        required: true
    validation:
      rules:
        - field: "lookupType"
          pattern: "currency"
          message: "Lookup type must be 'currency' for currency rates lookup"

  - id: "market-data-lookup"
    name: "Market Data Lookup"
    description: "Enrich data with market data from REST API"
    type: "lookup-enrichment"
    enabled: true
    condition: "#lookupType == 'market_data' && #symbol != null"
    
    lookup-config:
      lookup-key: "#symbol"
      lookup-dataset:
        type: "rest-api"
        data-source-ref: "market-data-api"
        operation-ref: "market-data"
        parameters:
          - field: "symbol"
            name: "symbol"
            type: "string"
    
    # Map the lookup results to target fields
    field-mappings:
      - source-field: "symbol"
        target-field: "marketSymbol"
        required: false
      - source-field: "name"
        target-field: "marketName"
        required: false
      - source-field: "bid"
        target-field: "bidPrice"
        required: false
      - source-field: "ask"
        target-field: "askPrice"
        required: false
      - source-field: "volume"
        target-field: "tradingVolume"
        required: false
      - source-field: "change_percent"
        target-field: "changePercent"
        required: false

  - id: "metrics-lookup"
    name: "Metrics Lookup"
    description: "Enrich data with server metrics from REST API"
    type: "lookup-enrichment"
    enabled: true
    condition: "#lookupType == 'metrics'"
    
    lookup-config:
      lookup-key: "#lookupType"
      lookup-dataset:
        type: "rest-api"
        data-source-ref: "metrics-api"
        operation-ref: "metrics"
        parameters:
          - field: "lookupType"
            name: "lookupType"
            type: "string"
    
    # Map the lookup results to target fields
    field-mappings:
      - source-field: "server_metrics.total_requests"
        target-field: "totalRequests"
        required: false
      - source-field: "server_metrics.error_count"
        target-field: "errorCount"
        required: false
      - source-field: "server_metrics.success_rate"
        target-field: "successRate"
        required: false
      - source-field: "server_metrics.uptime_seconds"
        target-field: "uptimeSeconds"
        required: false
      - source-field: "endpoint_metrics"
        target-field: "endpointMetrics"
        required: false

# Optional validation rules for REST API lookup
validations:
  - id: "rest-api-lookup-validation"
    name: "REST API Lookup Validation"
    description: "Ensure lookup type is provided for REST API enrichment"
    type: "field-validation"
    enabled: true
    condition: "#lookupType != null"
    
    validation-config:
      field: "lookupType"
      rules:
        - type: "required"
          message: "Lookup type is required for REST API enrichment"
        - type: "enum"
          values: ["currency_rates", "market_data", "metrics"]
          message: "Lookup type must be one of: currency_rates, market_data, metrics"

# Processing configuration
processing:
  continue-on-error: true
  max-errors: 3
  error-handling: "log-and-continue"
  timeout: 10000
