# APEX Input Data Classification Phase 2 Test - Scenario Configuration
#
# PURPOSE:
# This scenario configuration demonstrates Phase 2 advanced features including
# SpEL-based business classification, advanced caching, and rich context evaluation.
# It defines the processing pipeline for complex financial data classification.
#
# PHASE 2 ADVANCED FEATURES:
# - SpEL expression evaluation for business rules
# - Rich context variables and complex rule logic
# - Advanced caching with performance optimization
# - Configuration hot-reload capabilities
# - Enhanced confidence scoring algorithms
#
# DEPENDENCIES:
# - InputDataClassificationPhase2Test-validation-rules.yaml
# - InputDataClassificationPhase2Test-enrichment-rules.yaml  
# - InputDataClassificationPhase2Test-business-rules.yaml
#
# @author Mark Andrew Ray-Smith Cityline Ltd
# @version 2.0.0
# @since 2024-12-28

metadata:
  id: "phase2-advanced-test-scenario"
  name: "Phase 2 Advanced Classification Test Scenario"
  version: "2.0.0"
  description: "Advanced scenario demonstrating Phase 2 SpEL integration and caching features"
  type: "scenario"
  business-domain: "Financial Services - Advanced Processing"
  owner: "apex-development-team@company.com"
  created: "2024-12-28"
  tags: ["phase2", "advanced", "spel", "caching", "financial", "testing"]

# Scenario Configuration
scenario:
  scenario-id: "phase2-advanced-test-scenario"
  name: "Phase 2 Advanced Classification Processing"
  description: "Comprehensive scenario for testing Phase 2 advanced features with SpEL and caching"

  # Processing Stages with Phase 2 Enhancements
  processing-stages:
    
    # Stage 1: Advanced Validation with SpEL
    - stage-name: "advanced-validation"
      config-file: "src/test/java/dev/mars/apex/demo/scenario/InputDataClassificationPhase2Test-validation-rules.yaml"
      execution-order: 1
      failure-policy: "continue-with-warnings"
      required: false
      stage-metadata:
        description: "Advanced validation using SpEL expressions for complex business rules"
        sla-ms: 100
        critical: false
        spel-enabled: true
        context-enrichment: true
        caching-enabled: true
    
    # Stage 2: SpEL-Enhanced Enrichment
    - stage-name: "spel-enrichment"
      config-file: "src/test/java/dev/mars/apex/demo/scenario/InputDataClassificationPhase2Test-enrichment-rules.yaml"
      execution-order: 2
      failure-policy: "continue-with-warnings"
      depends-on: ["advanced-validation"]
      stage-metadata:
        description: "Data enrichment with SpEL-based conditional logic"
        sla-ms: 200
        critical: false
        spel-enabled: true
        performance-monitoring: true
        cache-results: true
    
    # Stage 3: Business Classification with Advanced SpEL
    - stage-name: "business-classification"
      config-file: "src/test/java/dev/mars/apex/demo/scenario/InputDataClassificationPhase2Test-business-rules.yaml"
      execution-order: 3
      failure-policy: "continue-with-warnings"
      depends-on: ["advanced-validation"]
      stage-metadata:
        description: "Advanced business classification using complex SpEL expressions"
        sla-ms: 150
        critical: true
        spel-enabled: true
        context-variables: ["instrument", "counterparty", "riskMetrics", "marketData"]
        confidence-scoring: "enhanced"

# Phase 2 Advanced Configuration
phase2-features:
  
  # SpEL Integration Configuration
  spel-integration:
    enabled: true
    expression-caching: true
    context-enrichment: true
    
    # Rich Context Variables
    context-variables:
      # Financial Data Context
      financial-context:
        - name: "messageType"
          description: "Type of financial message"
          source: "#root.messageType"
        - name: "instrument"
          description: "Financial instrument details"
          source: "#root.instrument"
        - name: "counterparty"
          description: "Counterparty information"
          source: "#root.counterparty"
        - name: "riskMetrics"
          description: "Risk assessment metrics"
          source: "#root.riskMetrics"
        - name: "marketData"
          description: "Current market data"
          source: "#root.marketData"
      
      # Processing Context
      processing-context:
        - name: "source"
          description: "Data source system"
          source: "#context.source"
        - name: "region"
          description: "Processing region"
          source: "#context.metadata['region']"
        - name: "desk"
          description: "Trading desk"
          source: "#context.metadata['desk']"
        - name: "priority"
          description: "Processing priority"
          source: "#context.metadata['priority']"
    
    # Advanced SpEL Functions
    custom-functions:
      - name: "isDerivative"
        expression: >
          #instrument != null && 
          (#instrument.type.contains('SWAP') || 
           #instrument.type.contains('OPTION') || 
           #instrument.type.contains('FUTURE') ||
           #instrument.type.contains('FORWARD'))
      
      - name: "isHighRisk"
        expression: >
          #riskMetrics != null && 
          (#riskMetrics.var95 > 100000 || 
           #riskMetrics.expectedShortfall > 150000 ||
           (#marketData != null && #marketData.volatility > 0.2))
      
      - name: "requiresRegulatory"
        expression: >
          #instrument?.regulatoryClassification == 'OTC_DERIVATIVE' ||
          (#counterparty?.jurisdiction != null && 
           #instrument?.notional > 1000000)
  
  # Advanced Caching Configuration
  advanced-caching:
    enabled: true
    
    # Cache Policies
    policies:
      classification-cache:
        ttl-seconds: 300
        max-size: 10000
        eviction-policy: "LRU"
        refresh-ahead: true
        statistics-enabled: true
      
      spel-expression-cache:
        ttl-seconds: 600
        max-size: 5000
        eviction-policy: "LFU"
        preload-common-expressions: true
      
      context-cache:
        ttl-seconds: 180
        max-size: 2000
        eviction-policy: "TIME_BASED"
    
    # Performance Optimization
    optimization:
      async-cache-refresh: true
      batch-cache-operations: true
      cache-warming: true
      compression: false
  
  # Hot-Reload Configuration
  hot-reload:
    enabled: true
    watch-paths:
      - "src/test/java/dev/mars/apex/demo/scenario/"
    reload-interval-seconds: 5
    validation-on-reload: true
    zero-downtime: true
    
    # Reload Triggers
    triggers:
      - file-change: "*.yaml"
      - config-validation: true
      - cache-invalidation: true

# Business Classification Rules
business-classification:
  
  # Derivative Instruments
  derivatives:
    condition: >
      #isDerivative() && 
      #instrument.notional > 0
    classification: "DERIVATIVE_INSTRUMENT"
    confidence: 0.95
    
  # High Risk Instruments  
  high-risk:
    condition: >
      #isHighRisk() ||
      (#instrument?.riskRating != null && 
       (#instrument.riskRating.startsWith('B') || 
        #instrument.riskRating.startsWith('C')))
    classification: "HIGH_RISK_INSTRUMENT"
    confidence: 0.90
    
  # Regulatory Reporting Required
  regulatory:
    condition: >
      #requiresRegulatory() ||
      (#counterparty?.lei != null && 
       #instrument?.type == 'OTC_DERIVATIVE')
    classification: "REGULATORY_REPORTING_REQUIRED"
    confidence: 0.88
    
  # Portfolio Management
  portfolio:
    condition: >
      #messageType == 'POSITION_REPORT' ||
      #messageType == 'PORTFOLIO_VALUATION' ||
      (#portfolio != null && #positions != null)
    classification: "PORTFOLIO_MANAGEMENT"
    confidence: 0.85
    
  # Risk Assessment
  risk-assessment:
    condition: >
      #riskMetrics != null && 
      (#riskMetrics.var95 != null || 
       #riskMetrics.expectedShortfall != null ||
       #riskMetrics.portfolioBeta != null)
    classification: "RISK_ASSESSMENT"
    confidence: 0.87

# Enhanced Confidence Scoring
confidence-scoring:
  algorithm: "weighted-multi-factor"
  
  factors:
    - name: "format-detection"
      weight: 0.3
      base-score: 0.8
    
    - name: "content-analysis"
      weight: 0.3
      spel-enhanced: true
      context-bonus: 0.1
    
    - name: "business-classification"
      weight: 0.4
      spel-evaluation: true
      rule-matching-bonus: 0.15
  
  # Confidence Thresholds
  thresholds:
    high-confidence: 0.85
    medium-confidence: 0.65
    low-confidence: 0.45
    
  # Confidence Adjustments
  adjustments:
    spel-success-bonus: 0.05
    cache-hit-bonus: 0.02
    context-richness-bonus: 0.03
    error-penalty: -0.10

# Performance Monitoring
performance-monitoring:
  enabled: true
  
  metrics:
    - "classification-time-ms"
    - "spel-evaluation-time-ms"
    - "cache-hit-ratio"
    - "cache-miss-ratio"
    - "context-enrichment-time-ms"
    - "confidence-score-distribution"
  
  thresholds:
    max-classification-time-ms: 50
    min-cache-hit-ratio: 0.80
    max-spel-evaluation-time-ms: 20
  
  alerts:
    performance-degradation: true
    cache-efficiency-low: true
    spel-errors-high: true
