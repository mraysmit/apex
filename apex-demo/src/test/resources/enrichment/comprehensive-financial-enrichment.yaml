# Comprehensive Financial Enrichment Configuration
# Real APEX YAML configuration demonstrating comprehensive financial services enrichment capabilities
# Replaces multiple generic demo configurations with meaningful business scenarios

metadata:
  id: "comprehensive-financial-enrichment"
  name: "Comprehensive Financial Enrichment"
  version: "1.0.0"
  description: "Comprehensive financial services enrichment demonstrating real APEX capabilities including trade processing, risk management, settlement processing, and regulatory compliance"
  type: "rule-config"
  author: "apex.demo.team@company.com"
  created-date: "2025-01-16"
  tags: ["apex-demo", "enrichment", "financial-services", "comprehensive"]

# Data sources for financial enrichment
data-sources:
  - name: "financial-reference-data"
    type: "inline"
    description: "Financial reference data for enrichment processing"

# Comprehensive Financial Services Enrichments
enrichments:
  # 1. Trade Settlement Processing
  - id: "trade-settlement-processing"
    name: "trade-settlement-processing"
    type: "calculation-enrichment"
    description: "Calculate settlement details based on market conventions and asset class"
    condition: "#market != null && #assetClass != null"
    calculation-config:
      expression: "#market == 'US' ? (#assetClass == 'EQUITY' ? 'T+2 DVP via DTC' : (#assetClass == 'BOND' ? 'T+1 DVP via Fedwire' : 'T+3 Standard')) : (#market == 'UK' ? (#assetClass == 'EQUITY' ? 'T+2 DVP via CREST' : 'T+1 DVP via CHAPS') : 'T+3 Correspondent Banking')"
      result-field: "settlementInstruction"
    field-mappings:
      - source-field: "settlementInstruction"
        target-field: "settlementInstruction"

  # 2. Currency Risk Assessment
  - id: "currency-risk-assessment"
    name: "currency-risk-assessment"
    type: "calculation-enrichment"
    description: "Assess currency risk for cross-border transactions"
    condition: "#baseCurrency != null && #tradeCurrency != null && #baseCurrency != #tradeCurrency"
    calculation-config:
      expression: "'Currency Risk: ' + #baseCurrency + '/' + #tradeCurrency + ' - Volatility: ' + (#tradeCurrency == 'USD' ? 'LOW' : (#tradeCurrency == 'EUR' ? 'MEDIUM' : (#tradeCurrency == 'GBP' ? 'MEDIUM' : 'HIGH'))) + ' - Hedge Required: ' + (#amount > 1000000 ? 'YES' : 'NO')"
      result-field: "currencyRiskAssessment"
    field-mappings:
      - source-field: "currencyRiskAssessment"
        target-field: "currencyRiskAssessment"

  # 3. Regulatory Capital Calculation
  - id: "regulatory-capital-calculation"
    name: "regulatory-capital-calculation"
    type: "calculation-enrichment"
    description: "Calculate regulatory capital requirements based on Basel III"
    condition: "#assetClass != null && #amount != null && #amount > 0"
    calculation-config:
      expression: "#amount * (#assetClass == 'EQUITY' ? 0.08 : (#assetClass == 'BOND' ? (#rating == 'AAA' ? 0.02 : (#rating == 'BBB' ? 0.04 : 0.08)) : (#assetClass == 'DERIVATIVE' ? 0.12 : 0.10)))"
      result-field: "regulatoryCapital"
    field-mappings:
      - source-field: "regulatoryCapital"
        target-field: "regulatoryCapital"

  # 4. Counterparty Credit Risk Scoring
  - id: "counterparty-credit-risk"
    name: "counterparty-credit-risk"
    type: "field-enrichment"
    description: "Assess counterparty credit risk based on rating and exposure"
    condition: "#counterpartyId != null"
    field-mappings:
      - source-field: "counterpartyId"
        target-field: "creditRiskScore"
        expression: "#counterpartyId.startsWith('CP001') ? 'AAA-LOW-RISK' : (#counterpartyId.startsWith('CP002') ? 'AA-MEDIUM-RISK' : (#counterpartyId.startsWith('CP003') ? 'BBB-HIGH-RISK' : 'UNRATED-VERY-HIGH-RISK'))"
      - source-field: "counterpartyId"
        target-field: "creditLimit"
        expression: "#counterpartyId.startsWith('CP001') ? 100000000 : (#counterpartyId.startsWith('CP002') ? 50000000 : (#counterpartyId.startsWith('CP003') ? 25000000 : 5000000))"

  # 5. Market Data Enrichment
  - id: "market-data-enrichment"
    name: "market-data-enrichment"
    type: "field-enrichment"
    description: "Enrich trades with market data and pricing information"
    condition: "#instrumentId != null"
    field-mappings:
      - source-field: "instrumentId"
        target-field: "marketDataSource"
        expression: "#instrumentId.startsWith('US') ? 'Bloomberg-US' : (#instrumentId.startsWith('GB') ? 'Reuters-UK' : (#instrumentId.startsWith('DE') ? 'Deutsche-Boerse' : 'Generic-Feed'))"
      - source-field: "instrumentId"
        target-field: "pricingModel"
        expression: "#assetClass == 'EQUITY' ? 'Last-Trade-Price' : (#assetClass == 'BOND' ? 'Yield-To-Maturity' : (#assetClass == 'DERIVATIVE' ? 'Black-Scholes' : 'Mark-To-Market'))"

  # 6. Compliance Screening
  - id: "compliance-screening"
    name: "compliance-screening"
    type: "calculation-enrichment"
    description: "Screen transactions for regulatory compliance and sanctions"
    condition: "#counterpartyId != null && #amount != null"
    calculation-config:
      expression: "'Compliance Status: ' + (#amount > 10000000 ? 'LARGE-EXPOSURE-REVIEW-REQUIRED' : 'STANDARD-PROCESSING') + ' - Sanctions Check: ' + (#counterpartyId.contains('SANCTIONED') ? 'BLOCKED' : 'CLEAR') + ' - AML Status: ' + (#amount > 50000 ? 'ENHANCED-DUE-DILIGENCE' : 'STANDARD-MONITORING')"
      result-field: "complianceStatus"
    field-mappings:
      - source-field: "complianceStatus"
        target-field: "complianceStatus"

  # 7. Portfolio Risk Metrics
  - id: "portfolio-risk-metrics"
    name: "portfolio-risk-metrics"
    type: "calculation-enrichment"
    description: "Calculate portfolio-level risk metrics including VaR and concentration"
    condition: "#portfolioId != null && #amount != null"
    calculation-config:
      expression: "'Portfolio Risk - VaR (1-day, 99%): $' + T(java.lang.Math).round(#amount * 0.025) + ' - Concentration Risk: ' + (#amount > 5000000 ? 'HIGH' : (#amount > 1000000 ? 'MEDIUM' : 'LOW')) + ' - Diversification Score: ' + (#assetClass == 'EQUITY' ? '0.7' : (#assetClass == 'BOND' ? '0.9' : '0.5'))"
      result-field: "portfolioRiskMetrics"
    field-mappings:
      - source-field: "portfolioRiskMetrics"
        target-field: "portfolioRiskMetrics"

  # 8. Trade Lifecycle Status
  - id: "trade-lifecycle-status"
    name: "trade-lifecycle-status"
    type: "field-enrichment"
    description: "Determine trade lifecycle status and next processing steps"
    condition: "#tradeStatus != null"
    field-mappings:
      - source-field: "tradeStatus"
        target-field: "lifecycleStage"
        expression: "#tradeStatus == 'NEW' ? 'TRADE-CAPTURE' : (#tradeStatus == 'CONFIRMED' ? 'SETTLEMENT-PENDING' : (#tradeStatus == 'SETTLED' ? 'POST-TRADE-PROCESSING' : 'EXCEPTION-HANDLING'))"
      - source-field: "tradeStatus"
        target-field: "nextAction"
        expression: "#tradeStatus == 'NEW' ? 'SEND-CONFIRMATION' : (#tradeStatus == 'CONFIRMED' ? 'INITIATE-SETTLEMENT' : (#tradeStatus == 'SETTLED' ? 'GENERATE-REPORTS' : 'INVESTIGATE-EXCEPTION'))"

# Business rules for financial processing
business-rules:
  settlement-rules:
    - "All equity trades must settle T+2 in developed markets"
    - "Government bonds settle T+1 in domestic markets"
    - "Cross-border trades require currency hedging above $1M"
    
  risk-management-rules:
    - "Counterparty exposure limits must be monitored real-time"
    - "Portfolio VaR must not exceed 2.5% of NAV"
    - "Concentration limits: max 10% in single issuer"
    
  compliance-rules:
    - "All trades >$10M require enhanced monitoring"
    - "Sanctions screening mandatory for all counterparties"
    - "Regulatory reporting required within T+1"

# Quality assurance
quality-assurance:
  data-quality:
    - "All financial calculations must be auditable"
    - "Market data sources must be validated"
    - "Risk metrics must be back-tested"
    
  operational-efficiency:
    - "Settlement instructions must be STP-enabled"
    - "Exception handling must be automated where possible"
    - "Regulatory reporting must be real-time"
    
  business-alignment:
    - "Risk metrics must align with business strategy"
    - "Compliance checks must meet regulatory requirements"
    - "Settlement processing must optimize capital efficiency"
