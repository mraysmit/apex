# ============================================================================
# APEX Rules Engine - Settlement Validation Rules Configuration
# ============================================================================
#
# This configuration file contains comprehensive validation rules for
# settlement processing, including custody operations, payment instructions,
# and settlement lifecycle management.
#
# SCOPE:
# - Settlement instruction validation
# - Custody and safekeeping validation
# - Payment and delivery validation
# - Settlement timing and cut-off validation
# - Regulatory compliance for settlement
#
# INTEGRATION:
# This file is referenced by scenario configurations that process settlement
# data and provides additional validation rules beyond those defined in
# bootstrap configurations.
#
# ============================================================================

metadata:
  id: "settlement-validation-rules"
  name: "Settlement Validation Rules"
  version: "1.0.0"
  description: "Comprehensive validation rules for settlement processing and custody operations"
  type: "rule-config"
  author: "settlement.operations@company.com"
  created-by: "settlement.operations@company.com"
  business-domain: "Settlement Operations"
  business-owner: "Settlement Operations Team"
  created-date: "2025-08-11"
  tags: ["settlement", "validation", "custody", "operations", "compliance"]

# ============================================================================
# SETTLEMENT INSTRUCTION VALIDATION RULES
# ============================================================================
#
# These rules ensure that settlement instructions have proper structure
# and required information for successful processing.
#
rules:
  # Basic Instruction Validation
  - id: "settlement-validation-rules"
    name: "Settlement Instruction ID Required"
    condition: "#settlementInstructionId != null && #settlementInstructionId.length() >= 8"
    message: "Settlement instruction ID must be at least 8 characters"
    severity: "ERROR"
    priority: 1
    categories: ["structural", "identification"]

  - id: "settlement-validation-rules"
    name: "Settlement Date Required"
    condition: "#settlementDate != null"
    message: "Settlement date is required for all settlement instructions"
    severity: "ERROR"
    priority: 1
    categories: ["structural", "temporal"]

  - id: "settlement-validation-rules"
    name: "Settlement Amount Must Be Positive"
    condition: "#settlementAmount != null && #settlementAmount > 0"
    message: "Settlement amount must be positive"
    severity: "ERROR"
    priority: 1
    categories: ["structural", "financial"]

  # Currency and Account Validation
  - id: "settlement-validation-rules"
    name: "Valid Settlement Currency"
    condition: "#settlementCurrency != null && #settlementCurrency in {'USD', 'EUR', 'GBP', 'JPY', 'CHF', 'CAD', 'AUD'}"
    message: "Settlement currency must be a supported currency"
    severity: "ERROR"
    priority: 2
    categories: ["business-logic", "currency"]

  - id: "settlement-validation-rules"
    name: "Account Number Format Validation"
    condition: "#accountNumber != null && #accountNumber.matches('^[A-Z0-9]{8,20}$')"
    message: "Account number must be 8-20 alphanumeric characters"
    severity: "ERROR"
    priority: 2
    categories: ["structural", "account"]

# ============================================================================
# CUSTODY AND SAFEKEEPING VALIDATION RULES
# ============================================================================
#
# These rules validate custody-related information and ensure proper
# safekeeping arrangements for securities and assets.
#
  # Custodian Validation
  - id: "settlement-validation-rules"
    name: "Custodian Required for Securities"
    condition: "#assetType == 'SECURITY' ? #custodian != null : true"
    message: "Custodian is required for security settlements"
    severity: "ERROR"
    priority: 1
    categories: ["business-logic", "custody"]

  - id: "settlement-validation-rules"
    name: "Custodian Authorization Check"
    condition: "#custodian != null ? #custodian in {'DTCC', 'EUROCLEAR', 'CLEARSTREAM', 'CREST', 'SIX'} : true"
    message: "Custodian must be an authorized central securities depository"
    severity: "WARNING"
    priority: 3
    categories: ["business-logic", "custody", "authorization"]

  # Asset and Security Validation
  - id: "settlement-validation-rules"
    name: "Security Identifier Required"
    condition: "#assetType == 'SECURITY' ? (#isin != null || #cusip != null || #sedol != null) : true"
    message: "Security identifier (ISIN, CUSIP, or SEDOL) required for securities"
    severity: "ERROR"
    priority: 1
    categories: ["structural", "identification", "securities"]

  - id: "settlement-validation-rules"
    name: "ISIN Format Validation"
    condition: "#isin == null || #isin.matches('^[A-Z]{2}[A-Z0-9]{9}[0-9]$')"
    message: "ISIN must follow ISO 6166 format (12 characters)"
    severity: "ERROR"
    priority: 2
    categories: ["structural", "securities", "format"]

# ============================================================================
# SETTLEMENT TIMING VALIDATION RULES
# ============================================================================
#
# These rules ensure settlement instructions comply with timing requirements,
# cut-off times, and settlement cycles.
#
  # Settlement Date Validation
  - id: "settlement-validation-rules"
    name: "Settlement Date Must Be Future"
    condition: "#settlementDate != null && #settlementDate.isAfter(T(java.time.LocalDate).now())"
    message: "Settlement date must be in the future"
    severity: "ERROR"
    priority: 1
    categories: ["business-logic", "temporal"]

  - id: "settlement-validation-rules"
    name: "Settlement Cycle Compliance"
    condition: "#tradeDate != null && #settlementDate != null && T(java.time.temporal.ChronoUnit).DAYS.between(#tradeDate, #settlementDate) <= 3"
    message: "Settlement must occur within T+3 cycle"
    severity: "WARNING"
    priority: 3
    categories: ["business-logic", "temporal", "regulatory"]

  - id: "settlement-validation-rules"
    name: "Cut-off Time Validation"
    condition: "#instructionTime != null && #instructionTime.isBefore(T(java.time.LocalTime).of(15, 0))"
    message: "Settlement instructions must be submitted before 3:00 PM cut-off"
    severity: "WARNING"
    priority: 4
    categories: ["operational", "timing"]

# ============================================================================
# PAYMENT AND DELIVERY VALIDATION RULES
# ============================================================================
#
# These rules validate payment instructions and delivery arrangements
# for settlement processing.
#
  # Payment Method Validation
  - id: "settlement-validation-rules"
    name: "Payment Method Required"
    condition: "#paymentMethod != null && #paymentMethod in {'WIRE', 'ACH', 'SWIFT', 'FEDWIRE', 'CHAPS'}"
    message: "Valid payment method is required"
    severity: "ERROR"
    priority: 2
    categories: ["business-logic", "payment"]

  - id: "settlement-validation-rules"
    name: "Bank Details Required for Wire Transfers"
    condition: "#paymentMethod == 'WIRE' ? (#bankSwiftCode != null && #bankAccountNumber != null) : true"
    message: "SWIFT code and bank account number required for wire transfers"
    severity: "ERROR"
    priority: 1
    categories: ["structural", "payment", "banking"]

  # Delivery Instructions
  - id: "settlement-validation-rules"
    name: "Delivery Method for Securities"
    condition: "#assetType == 'SECURITY' ? #deliveryMethod in {'DTC', 'BOOK_ENTRY', 'PHYSICAL'} : true"
    message: "Valid delivery method required for securities"
    severity: "ERROR"
    priority: 2
    categories: ["business-logic", "delivery", "securities"]

# ============================================================================
# RISK AND COMPLIANCE VALIDATION RULES
# ============================================================================
#
# These rules implement risk controls and regulatory compliance
# requirements for settlement operations.
#
  # Settlement Risk Controls
  - id: "settlement-validation-rules"
    name: "Settlement Amount Limit Check"
    condition: "#settlementAmount <= 10000000"
    message: "Settlement amount exceeds daily limit of 10 million"
    severity: "WARNING"
    priority: 3
    categories: ["risk-management", "limits"]

  - id: "settlement-validation-rules"
    name: "Counterparty Settlement Limit"
    condition: "#counterpartyId != null && #settlementAmount <= 5000000"
    message: "Settlement amount exceeds counterparty limit"
    severity: "INFO"
    priority: 4
    categories: ["risk-management", "counterparty", "limits"]

  # Regulatory Compliance
  - id: "settlement-validation-rules"
    name: "AML Screening Required"
    condition: "#settlementAmount >= 10000"
    message: "AML screening required for settlements over 10,000"
    severity: "INFO"
    priority: 5
    categories: ["regulatory", "aml", "compliance"]

  - id: "settlement-validation-rules"
    name: "Sanctions Check Required"
    condition: "#counterpartyJurisdiction != null && #counterpartyJurisdiction not in {'US', 'EU', 'UK', 'CA', 'AU', 'JP'}"
    message: "Sanctions screening required for non-allied jurisdictions"
    severity: "WARNING"
    priority: 3
    categories: ["regulatory", "sanctions", "compliance"]

# ============================================================================
# OPERATIONAL VALIDATION RULES
# ============================================================================
#
# These rules ensure operational requirements are met for successful
# settlement processing.
#
  # System and Infrastructure
  - id: "settlement-validation-rules"
    name: "Settlement System Availability"
    condition: "#settlementSystem != null && #settlementSystem in {'SWIFT', 'FEDWIRE', 'TARGET2', 'CHAPS'}"
    message: "Settlement system must be available and supported"
    severity: "ERROR"
    priority: 1
    categories: ["operational", "infrastructure"]

  - id: "settlement-validation-rules"
    name: "Backup Settlement Method"
    condition: "#backupSettlementMethod != null"
    message: "Backup settlement method should be specified for contingency"
    severity: "INFO"
    priority: 5
    categories: ["operational", "contingency"]

# ============================================================================
# PROCESSING CONFIGURATION
# ============================================================================
#
# Configuration settings for settlement validation processing.
#
processing:
  # Error Handling
  stopOnFirstError: false
  enableValidation: true
  
  # Performance Settings
  batchSize: 100
  
  # Logging and Monitoring
  logLevel: "INFO"
  enableAuditTrail: true
  enablePerformanceTracking: true
