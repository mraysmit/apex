metadata:
  name: "Rule-Chain Document Complex Workflow Test"
  version: "1.0.0"
  description: "Test rule-chain document with complex workflow pattern"
  type: "rule-chain"
  id: "rule-chain-workflow-test"
  author: "apex-test-suite@example.com"
  created: "2025-09-14"
  last-modified: "2025-09-14"
  tags: ["test", "rule-chain", "complex", "workflow"]

rule-chains:
  # Trade Processing Complex Workflow
  - id: "trade-processing-workflow"
    name: "Trade Processing Complex Workflow"
    description: "Complex workflow for comprehensive trade processing"
    pattern: "complex-workflow"
    enabled: true
    priority: 10
    category: "trade-processing"
    
    configuration:
      stages:
        # Pre-Validation Stage
        - stage: "pre-validation"
          name: "Pre-Validation Stage"
          description: "Initial trade data validation"
          rules:
            - condition: "#tradeType != null && #notionalAmount != null && #counterparty != null"
              message: "Basic trade data validation passed"
              severity: "INFO"
            - condition: "#tradeDate != null && #settlementDate != null"
              message: "Trade dates validation passed"
              severity: "INFO"
          failure-action: "terminate"
          output-variables:
            - "preValidationPassed"

        # Risk Assessment Stage
        - stage: "risk-assessment"
          name: "Risk Assessment Stage"
          description: "Comprehensive risk evaluation"
          depends-on: ["pre-validation"]
          rules:
            - condition: "#notionalAmount > 1000000 && #marketVolatility > 0.2 ? 'HIGH' : 'MEDIUM'"
              message: "Risk level assessment completed"
              severity: "INFO"
            - condition: "#counterpartyRating != null && #counterpartyRating >= 'BBB'"
              message: "Counterparty risk assessment passed"
              severity: "INFO"
          output-variable: "riskLevel"
          conditional-execution:
            condition: "#preValidationPassed == true"

        # Approval Stage
        - stage: "approval"
          name: "Approval Stage"
          description: "Trade approval workflow"
          depends-on: ["risk-assessment"]
          conditional-execution:
            condition: "#riskLevel == 'HIGH'"
            on-true:
              rules:
                - condition: "#seniorApprovalRequired == true"
                  message: "Senior approval required for high-risk trade"
                  severity: "WARN"
                - condition: "#seniorApprovalObtained == true"
                  message: "Senior approval obtained"
                  severity: "INFO"
            on-false:
              rules:
                - condition: "#standardApprovalObtained == true"
                  message: "Standard approval obtained"
                  severity: "INFO"
          output-variable: "approvalStatus"

        # Settlement Preparation Stage
        - stage: "settlement-preparation"
          name: "Settlement Preparation Stage"
          description: "Prepare trade for settlement"
          depends-on: ["approval"]
          parallel-execution: true
          sub-stages:
            - sub-stage: "cash-settlement"
              name: "Cash Settlement Preparation"
              rules:
                - condition: "#cashSettlementRequired == true"
                  message: "Cash settlement instructions prepared"
                  severity: "INFO"
            - sub-stage: "security-settlement"
              name: "Security Settlement Preparation"
              rules:
                - condition: "#securitySettlementRequired == true"
                  message: "Security settlement instructions prepared"
                  severity: "INFO"
          output-variable: "settlementReady"

        # Final Processing Stage
        - stage: "final-processing"
          name: "Final Processing Stage"
          description: "Complete trade processing"
          depends-on: ["settlement-preparation"]
          rules:
            - condition: "#approvalStatus == 'APPROVED' && #settlementReady == true"
              message: "Trade processing completed successfully"
              severity: "INFO"
          success-action: "complete-trade-processing"
          failure-action: "escalate-to-operations"

  # Regulatory Compliance Complex Workflow
  - id: "regulatory-compliance-workflow"
    name: "Regulatory Compliance Complex Workflow"
    description: "Complex workflow for regulatory compliance processing"
    pattern: "complex-workflow"
    enabled: true
    priority: 20
    category: "regulatory-compliance"
    
    configuration:
      stages:
        # Jurisdiction Detection
        - stage: "jurisdiction-detection"
          name: "Jurisdiction Detection"
          description: "Detect applicable regulatory jurisdictions"
          rules:
            - condition: "#customerLocation != null && #tradeLocation != null"
              message: "Jurisdiction detection completed"
              severity: "INFO"
          output-variable: "applicableJurisdictions"

        # Regulatory Rules Application
        - stage: "regulatory-rules"
          name: "Regulatory Rules Application"
          description: "Apply jurisdiction-specific regulatory rules"
          depends-on: ["jurisdiction-detection"]
          dynamic-execution:
            based-on: "#applicableJurisdictions"
            rules:
              - jurisdiction: "US"
                rules:
                  - condition: "#notionalAmount >= 10000"
                    message: "US reporting threshold check"
                    severity: "INFO"
              - jurisdiction: "EU"
                rules:
                  - condition: "#mifidReportingRequired == true"
                    message: "MiFID II reporting requirements check"
                    severity: "INFO"
          output-variable: "complianceStatus"

        # Reporting Generation
        - stage: "reporting"
          name: "Regulatory Reporting"
          description: "Generate required regulatory reports"
          depends-on: ["regulatory-rules"]
          rules:
            - condition: "#complianceStatus == 'COMPLIANT'"
              message: "Regulatory reports generated"
              severity: "INFO"
          success-action: "submit-regulatory-reports"
