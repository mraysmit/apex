<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js YAML Dependency Tree Viewer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        #tree-container {
            width: 100%;
            height: 90vh;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .node circle {
            fill: #69b3a2;
            stroke: #333;
            stroke-width: 2px;
            cursor: pointer;
        }
        
        .node circle:hover {
            fill: #4a9d8e;
        }
        
        .node text {
            font-size: 12px;
            font-family: Arial, sans-serif;
            fill: #333;
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2px;
        }
        
        .node.collapsed circle {
            fill: #ff6b6b;
        }
        
        .node.has-children circle {
            fill: #4ecdc4;
        }
        
        .node.leaf circle {
            fill: #95e1d3;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #d32f2f;
            font-size: 16px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>D3.js YAML Dependency Tree Viewer</h1>
    
    <div id="tree-container">
        <div id="loading">Loading tree data...</div>
        <div id="error" style="display: none;"></div>
    </div>

    <script>
        // Global variables
        let svg, g, tree, root, i = 0;
        const duration = 750;
        const width = window.innerWidth - 40;
        const height = window.innerHeight * 0.9 - 60;
        
        // Initialize the tree viewer
        function initializeTree() {
            // Show loading message initially
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Loading tree data...';
            
            // Create SVG container
            svg = d3.select("#tree-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // Create main group for zoom/pan
            g = svg.append("g");
            
            // Set up zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", function(event) {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            // Create tree layout
            tree = d3.tree().size([height - 100, width - 200]);
            
            // Load data from REST API (with small delay for testing)
            setTimeout(() => {
                loadTreeData();
            }, 100);
        }
        
        // Load tree data from REST API
        function loadTreeData() {
            // Use the graph-100 dataset which has 100+ files with deep dependencies
            // Need to use absolute path for proper dependency resolution
            const rootFile = "C:/Users/markr/dev/java/corejava/apex-rules-engine/apex-yaml-manager/src/test/resources/apex-yaml-samples/graph-100/00-scenario-registry.yaml";
            // Updated to use centralized apex-rest-api (port 8080) instead of apex-yaml-manager (port 8082)
            const apiUrl = `http://localhost:8080/api/dependencies/tree?rootFile=${encodeURIComponent(rootFile)}`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Loaded tree data:', data);
                    // Handle both old format (apex-yaml-manager) and new format (apex-rest-api)
                    if (data.success && data.data && data.data.tree) {
                        // New apex-rest-api format
                        processTreeData(data.data.tree);
                    } else if (data.status === 'success' && data.tree) {
                        // Old apex-yaml-manager format (fallback)
                        processTreeData(data.tree);
                    } else {
                        throw new Error('Invalid API response: ' + (data.message || data.error || 'No tree data'));
                    }
                })
                .catch(error => {
                    console.error('Error loading tree data:', error);
                    showError(`Failed to load tree data: ${error.message}`);
                    // Hide loading message on error
                    d3.select("#loading").style("display", "none");
                });
        }
        
        // Process and render tree data
        function processTreeData(treeData) {
            try {
                // Validate data
                if (!treeData) {
                    throw new Error("No data provided");
                }

                // Validate tree structure (must have name property)
                if (!treeData.name) {
                    throw new Error("Invalid tree structure: missing 'name' property");
                }

                // Convert to D3 hierarchy
                root = d3.hierarchy(treeData);
                
                // Set initial positions
                root.x0 = height / 2;
                root.y0 = 0;
                
                // Collapse all children initially except first level
                if (root.children) {
                    root.children.forEach(collapse);
                }
                
                // Render the tree
                update(root);
                
                // Center the tree
                const initialTransform = d3.zoomIdentity.translate(100, height / 2);
                svg.call(d3.zoom().transform, initialTransform);

                // Hide loading message and show success
                d3.select("#loading").style("display", "none");
                d3.select("#error").style("display", "none");

            } catch (error) {
                console.error('Error processing tree data:', error);
                showError(`Failed to process tree data: ${error.message}`);
                throw error; // Re-throw for testing purposes
            }
        }
        
        // Collapse a node and its children
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('error').innerHTML = message;
            document.getElementById('error').style.display = 'block';
        }
        
        // Update tree visualization
        function update(source) {
            // Compute the new tree layout
            const treeData = tree(root);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);
            
            // Normalize for fixed-depth
            nodes.forEach(d => d.y = d.depth * 180);
            
            // Update nodes
            const node = g.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));
            
            // Enter new nodes
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${source.y0},${source.x0})`)
                .on('click', click);
            
            // Add circles for nodes
            nodeEnter.append('circle')
                .attr('r', 1e-6)
                .style('fill', d => d._children ? '#ff6b6b' : '#69b3a2');
            
            // Add labels for nodes
            nodeEnter.append('text')
                .attr('dy', '.35em')
                .attr('x', d => d.children || d._children ? -13 : 13)
                .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
                .text(d => d.data.name || 'Unknown')
                .style('fill-opacity', 1e-6);
            
            // Update existing nodes
            const nodeUpdate = nodeEnter.merge(node);
            
            nodeUpdate.transition()
                .duration(duration)
                .attr('transform', d => `translate(${d.y},${d.x})`);
            
            nodeUpdate.select('circle')
                .attr('r', 6)
                .style('fill', d => d._children ? '#ff6b6b' : '#69b3a2')
                .attr('cursor', 'pointer');
            
            nodeUpdate.select('text')
                .style('fill-opacity', 1);
            
            // Remove exiting nodes
            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr('transform', d => `translate(${source.y},${source.x})`)
                .remove();
            
            nodeExit.select('circle')
                .attr('r', 1e-6);
            
            nodeExit.select('text')
                .style('fill-opacity', 1e-6);
            
            // Update links
            const link = g.selectAll('path.link')
                .data(links, d => d.id);
            
            // Enter new links
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('d', d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal(o, o);
                });
            
            // Update existing links
            const linkUpdate = linkEnter.merge(link);
            
            linkUpdate.transition()
                .duration(duration)
                .attr('d', d => diagonal(d, d.parent));
            
            // Remove exiting links
            link.exit().transition()
                .duration(duration)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();
            
            // Store old positions for transition
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
        
        // Create diagonal path between nodes
        function diagonal(s, d) {
            const path = `M ${s.y} ${s.x}
                         C ${(s.y + d.y) / 2} ${s.x},
                           ${(s.y + d.y) / 2} ${d.x},
                           ${d.y} ${d.x}`;
            return path;
        }
        
        // Handle node click (expand/collapse)
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeTree);
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (svg) {
                const newWidth = window.innerWidth - 40;
                const newHeight = window.innerHeight * 0.9 - 60;
                svg.attr("width", newWidth).attr("height", newHeight);
                tree.size([newHeight - 100, newWidth - 200]);
                if (root) update(root);
            }
        });
    </script>
</body>
</html>
