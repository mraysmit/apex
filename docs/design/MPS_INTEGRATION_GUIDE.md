# JetBrains MPS Integration Guide for APEX YAML

This guide explains how to design a minimal DSL in JetBrains MPS to produce APEX YAML configuration files, and how to validate those generated files inside this repository.

## Goals
- Author higher‑level models in MPS (domain concepts, constraints) and generate APEX YAML configs.
- Keep generated artifacts versioned and validated by CI.
- Avoid extra dependencies by reusing existing APEX YAML loader for validation.

## Where to put generated files
- Target folder in this repo: `apex-demo/demo-data/mps-generated`
- This folder is tracked in VCS and has a test that validates every YAML file in it.

## Validation pipeline
- We provide a JUnit 5 test (`MpsGeneratedYamlValidationTest`) that loads every `*.yaml`/`*.yml` file in `demo-data/mps-generated` using the built-in `YamlConfigurationLoader`.
- If the folder is empty, the test passes but reports a skip note.
- If a file fails to load, the test fails and shows a clear error message with the file path and the loader exception.

## Suggested MPS project layout
- Language: `apex.rules`
  - Structure concepts (examples):
    - `RuleSet` (properties: id, name, version, description, tags)
    - `Rule` (id, name, severity, message, description, condition as string)
    - `RuleGroup` (id, name, executionStrategy, rules: reference list to Rule)
    - `Metadata` (author, createdDate, type)
  - Constraints/Typesystem:
    - Enforce unique rule IDs within a RuleSet.
    - Enum for severity: INFO | WARNING | ERROR.
    - Non-empty strings for id/name; condition mandatory.
  - Editor:
    - Compact editors with intention menus to add rules and groups.
  - Generator:
    - Template(s) that produce a YAML mapping with keys:
      - `metadata`, `rules`, `rule-groups` (matching APEX YAML expectations)
    - Post-processing: format strings, quote handling for conditions.

## Example YAML target shape
A minimal expected structure the generator should produce:

```yaml
metadata:
  id: "sample"
  name: "Sample"
  version: "1.0.0"
  description: "Generated by MPS"
  type: "rule-config"
  author: "you@example.com"
  created-date: "2025-01-01"
  tags: ["apex", "mps", "generated"]

rules:
  - id: "simple-check"
    name: "Simple Check"
    condition: "#amount != null && #amount > 0"
    severity: "INFO"
    message: "Amount is positive"
    description: "Auto-generated rule"

rule-groups:
  - id: "default"
    name: "Default"
    description: "Generated group"
    execution-strategy: "all"
    rules:
      - rule-id: "simple-check"
```

## Generator output settings
- File extension: `.yaml`
- One `RuleSet` model => one YAML file. Suggested file naming: `${metadata.id}.yaml`.
- Output path (absolute or relative) must point to this repo folder:
  - On Windows (typical): `.../apex-demo/demo-data/mps-generated`

## Version control best practices
- Commit generated YAML files if they are used in tests/demos.
- Commit the MPS sources in a separate repository or in a subfolder (optional).
- Use meaningful model properties (id/version) so diffs are stable.

## Local workflow
1. In MPS, generate models to `apex-demo/demo-data/mps-generated`.
2. In IDE or CLI, run tests in `apex-demo` module. The `MpsGeneratedYamlValidationTest` will load and validate the generated files.
3. Fix any reported errors in your MPS models or generator.

## CI workflow
- Ensure the pipeline runs `mvn -pl apex-demo -am test` (or the parent build). The validation test will run automatically.

## Troubleshooting
- Loader errors often indicate missing required fields or formatting (e.g., condition quoting). Compare against working examples in `apex-demo/src/test/java/**/**/*.yaml`.
- If you need strict schema checks, consider adding a JSON Schema-based validator later. For now, the loader-based validation ensures compatibility with the engine.


---

# Hands-on: Build an MPS DSL that generates APEX YAML (Step-by-step)

Time: 45–90 minutes if you’re new to MPS. No Java coding in this repo is required.

Prerequisites:
- JetBrains MPS 2021.3+ (or newer)
- Basic familiarity with MPS concepts (Language, Structure, Editor, Generator)

What you’ll build:
- A minimal MPS language apex.rules that lets you define RuleSets, Rules, and RuleGroups
- A generator that produces APEX-compatible YAML to this repo’s folder: apex-demo/demo-data/mps-generated
- Use our test (MpsGeneratedYamlValidationTest) to validate what you generated

Quick map of DSL → YAML
- RuleSet → metadata + rules + rule-groups
- Rule → { id, name, condition, severity, message, description }
- RuleGroup → { id, name, description, execution-strategy, rules: [ { rule-id } ] }

1) Create the language
- In MPS: File → New Project → Language
  - Name: apex.rules
  - Keep defaults and Finish

2) Define Structure concepts
- In apex.rules → structure → add Concepts:
  - RuleSet
    - properties: id (string), name (string), version (string), description (string), type (string, default "rule-config"), author (string), createdDate (string), tags (string list)
    - children: rules (0..n Rule), groups (0..n RuleGroup)
  - Rule
    - properties: id (string), name (string), condition (string), severity (enum), message (string), description (string)
  - Severity (enum)
    - literals: INFO, WARNING, ERROR
  - RuleGroup
    - properties: id (string), name (string), description (string), executionStrategy (string, e.g. "all" | "first")
    - refs: ruleRefs (0..n to Rule)

3) Add Constraints (recommended)
- In apex.rules → constraints:
  - RuleSet: make id, name non-empty
  - Rule: id, name, condition non-empty
  - Enforce unique Rule.id within a RuleSet (use a search scope or a simple check function)

4) Add simple Editors
- In apex.rules → editor:
  - RuleSet editor showing metadata block (id, name, version, author, createdDate, tags) and sections Rules and Groups
  - Rule editor fields in a compact form
  - RuleGroup editor with a table for ruleRefs

5) Optional Typesystem hints
- Provide quick errors if condition is empty
- Ensure executionStrategy is one of [all, first] (or provide an enum instead of string)

6) Create a Generator that produces YAML
- In apex.rules → generator → New Generator for apex.rules
- Add a Template Model
- You can use either:
  A) TextGen (jetbrains.mps.lang.textGen) to generate strings directly
  B) A template + a single root rule that emits text through TextGen macros
- Minimal approach (pseudo-template):
  - Root mapping for RuleSet → produce a single text file ${id}.yaml
  - Use simple indent helpers to print YAML sections

7) Suggested TextGen pseudocode (for RuleSet)
- ConceptRuleSet_TextGen:
  - file name: ${ruleSet.id}.yaml
  - body:
    metadata:
      id: "${ruleSet.id}"
      name: "${ruleSet.name}"
      version: "${ruleSet.version}"
      description: "${ruleSet.description}"
      type: "${ruleSet.type}"  # usually "rule-config"
      author: "${ruleSet.author}"
      created-date: "${ruleSet.createdDate}"
      tags: [${join(ruleSet.tags, ", ", quote=true)}]

    rules:
    - for each rule in ruleSet.rules:
      - id: "${rule.id}"
        name: "${rule.name}"
        condition: "${escape(rule.condition)}"   # IMPORTANT: keep quotes
        severity: "${rule.severity}"
        message: "${rule.message}"
        description: "${rule.description}"

    rule-groups:
    - for each g in ruleSet.groups:
      - id: "${g.id}"
        name: "${g.name}"
        description: "${g.description}"
        execution-strategy: "${g.executionStrategy}"
        rules:
          - for each r in g.ruleRefs:
            - rule-id: "${r.target.id}"

Notes on formatting:
- Use double quotes around strings (especially condition) to avoid YAML parsing issues
- For tags list, output like: tags: ["t1", "t2"]
- Escape embedded quotes in condition: replace " with \"

8) Configure output folder to this repo
- In your MPS project, set the generation output path to the APEX repo’s folder apex-demo/demo-data/mps-generated
- Options:
  - Use a project variable (e.g., APEX_OUT) and set it to the absolute path of .../apex-demo/demo-data/mps-generated
  - Or configure build script/module properties so that TextGen writes to that directory

9) Create a sample model and generate
- Create a Solution module (e.g., apex.rules.sandbox)
- Add a model (sandbox) and create one RuleSet with 1–3 Rules and a default RuleGroup referencing those rules
- Generate (Ctrl+F9). Verify YAML files appear in apex-demo/demo-data/mps-generated

10) Validate using the included JUnit test
- From this repo’s root:
  mvn -pl apex-demo -am test
- The test MpsGeneratedYamlValidationTest will scan apex-demo/demo-data/mps-generated and try to load each YAML using the engine’s YamlConfigurationLoader
- Fix any errors and re-generate until it passes

11) Example minimal RuleSet to try in MPS
- RuleSet:
  - id: "sample"
  - name: "Sample"
  - version: "1.0.0"
  - author: "you@example.com"
  - createdDate: "2025-01-01"
  - tags: ["apex", "mps", "generated"]
  - rules:
    - Rule(id: "simple-check", name: "Simple Check", severity: INFO,
           condition: "#amount != null && #amount > 0",
           message: "Amount is positive", description: "Auto-generated rule")
  - groups:
    - RuleGroup(id: "default", name: "Default", executionStrategy: "all",
                ruleRefs: [simple-check])

12) Troubleshooting tips (MPS → YAML)
- If the test fails with loader errors:
  - Ensure metadata.type == "rule-config"
  - Make sure condition is quoted; YAML treats unquoted special chars unexpectedly
  - Confirm rule IDs are unique and referenced correctly in rule-groups.rules[].rule-id
  - Compare with working examples under apex-demo/src/test/java/**/**/*.yaml
- If files don’t show up:
  - Check your generator’s output path and write permissions
  - Confirm generation actually ran (Rebuild Project)

13) Going further
- Add more concepts (Datasets, Lookups) and extend the generator to emit those optional APEX sections
- Add intentions and quick-fixes in the editor to enforce best practices
- Add a build solution to package and share the language with your team
